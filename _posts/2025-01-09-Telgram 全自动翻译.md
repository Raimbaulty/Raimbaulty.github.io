---
layout: mypost
title: Telgram å…¨è‡ªåŠ¨ç¿»è¯‘
date: 2025-01-09
published: true
categories: è‡ªéƒ¨ç½²
tags: 
 - telegram
---

ä»£ç åŸºäº Neo çš„å¸–å­ï¼š[**å°†Telegramå…¨è‡ªåŠ¨ç¿»è¯‘æ›´è¿›ä¸€æ­¥**](https://linux.do/t/topic/18308)

ä½¿ç”¨ Linux Do è®ºå›æä¾›çš„å…¬ç›Š DeeplX å¯¹ Telegram æ¶ˆæ¯è¿›è¡Œç¿»è¯‘

## å®‰è£…ä¾èµ–

```bash
pip install aiohttp telethon
```

## é…ç½®æ–‡ä»¶

æ–‡ä»¶ç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤º

    ğŸ“‚ telegram-translate/
    â”‚
    â”œâ”€â”€ ğŸ“œ config.json
    â”œâ”€â”€ ğŸ“œ main.py
    â””â”€â”€ ğŸ“œ chat_translator.session

#### åˆ›å»º config.json

api\_id å’Œ api\_hash é€šè¿‡ç”³è¯· Telegram åº”ç”¨è·å–ï¼š[ç”³è¯·åœ°å€](https://my.telegram.org/apps)

api\_key é€šè¿‡è®¿é—® Linux Do Connect å¤åˆ¶ **DeepLX Api Key** è·å–ï¼š[è·å–åœ°å€](https://connect.linux.do/)

```json
{
  "api_id": 123456, 
  "api_hash": "your_api_hash",
  "api_key": "your_api_key"
}
```

#### åˆ›å»º main.py

````python
# -*- coding: utf-8 -*-

import asyncio
import json
import logging
import os
import time

import aiohttp
from telethon import events
from telethon.sync import TelegramClient

# è®¾ç½®æ—¥å¿—è®°å½•ï¼Œä¾¿äºè°ƒè¯•å’Œè¿½è¸ªç¨‹åºè¿è¡Œæƒ…å†µã€‚
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')


def load_config():
    # load config from json file, check if the file exists first
    if not os.path.exists('config.json'):
        logging.error('config.json not found, created an empty one')
        exit()

    with open('config.json', 'r') as f:
        config = json.load(f)

    return config


def save_config():
    cfg['target_config'] = target_config
    with open('config.json', 'w') as f:
        json.dump(cfg, f, indent=2)


cfg = load_config()
api_id = cfg['api_id']
api_hash = cfg['api_hash']
api_key = cfg['api_key']
target_config = cfg['target_config'] if 'target_config' in cfg else {}

# åˆå§‹åŒ–Telegramå®¢æˆ·ç«¯å’ŒOpenAIå®¢æˆ·ç«¯ã€‚
client = TelegramClient('chat_translator', api_id, api_hash)


async def translate_single(text, source_lang, target_lang, session):
    if source_lang == target_lang:
        return target_lang, text

    url = f"https://api.deeplx.org/{api_key}/translate"
    payload = {
        "text": text,
        "source_lang": source_lang,
        "target_lang": target_lang
    }

    start_time = time.time()
    async with session.post(url, json=payload) as response:
        logging.info(f"ç¿»è¯‘ä» {source_lang} è‡³ {target_lang} è€—æ—¶: {time.time() - start_time}")
        if response.status != 200:
            logging.error(f"ç¿»è¯‘å¤±è´¥ï¼š{response.status}")
            raise Exception(f"ç¿»è¯‘å¤±è´¥")

        result = await response.json()
        if result['code'] != 200:
            logging.error(f"ç¿»è¯‘å¤±è´¥ï¼š{result}")
            raise Exception(f"ç¿»è¯‘å¤±è´¥")

        return target_lang, result['data']


async def translate_text(text, source_lang, target_langs) -> {}:
    result = {}
    async with aiohttp.ClientSession() as session:
        tasks = [translate_single(text, source_lang, target_lang, session) for target_lang in target_langs]
        for lang, text in await asyncio.gather(*tasks):
            result[lang] = text

    return result


async def command_mode(event, target_key, text) -> bool:
    if text == '.tt-off':
        await event.delete()

        if target_key in target_config:
            del target_config[target_key]
            save_config()
            logging.info("å·²ç¦ç”¨: %s" % target_key)

        return False

    if text.startswith('.tt-on,'):
        await event.delete()

        _, source_lang, target_langs = text.split(',')
        target_config[target_key] = {
            'source_lang': source_lang,
            'target_langs': target_langs.split('|')
        }

        save_config()
        logging.info(f"è®¾ç½®æˆåŠŸ: {target_config[target_key]}")

        return False

    return True


# ç›‘å¬æ–°æ¶ˆæ¯äº‹ä»¶ï¼Œè¿›è¡Œæ¶ˆæ¯å¤„ç†ã€‚
@client.on(events.NewMessage(outgoing=True))
async def handle_message(event):
    target_key = '%d.%d' % (event.chat_id, event.sender_id)
    try:
        message = event.message

        if not message.text:
            return

        message_content = message.text.strip()
        if not message_content:
            return

        if message_content.startswith('.tt-') and not await command_mode(event, target_key, message_content):
            return

        if target_key not in target_config:
            return

        logging.info(f"ç¿»è¯‘æ¶ˆæ¯: {message.text}")

        config = target_config[target_key]
        target_langs = config['target_langs']
        if not target_langs:
            return

        start_time = time.time()  # è®°å½•å¼€å§‹æ—¶é—´
        translated_texts = await translate_text(message.text, config['source_lang'], target_langs)
        logging.info(f"ç¿»è¯‘è€—æ—¶: {time.time() - start_time}")

        modified_message = translated_texts[target_langs[0]]

        if len(target_langs) > 1:
            secondary_messages = []
            for lang in target_langs[1:]:
                secondary_messages.append(translated_texts[lang])

            modified_message += '\n```%s\n```' % '\n'.join(secondary_messages)

        await message.edit(modified_message)
    except Exception as e:
        # è®°å½•å¤„ç†æ¶ˆæ¯æ—¶å‘ç”Ÿçš„å¼‚å¸¸ã€‚
        logging.error(f"Error handling message: {e}")


# å¯åŠ¨å®¢æˆ·ç«¯å¹¶ä¿æŒè¿è¡Œã€‚
try:
    client.start()
    client.run_until_disconnected()
finally:
    # æ–­å¼€å®¢æˆ·ç«¯è¿æ¥ã€‚
    client.disconnect()
````


#### åˆ›å»º chat\_translator.session

è¯•è¿è¡ŒæœåŠ¡åè‡ªåŠ¨ç”Ÿæˆ

```bash
python3 main.py
```

æŒ‰ç…§æç¤ºè¾“å…¥æ‰‹æœºå·ï¼ˆå¸¦åŒºå·ï¼Œå¦‚+861234567ï¼‰ï¼Œå¹¶è¾“å…¥å·²ç™»å½•è®¾å¤‡ä¸­æ”¶åˆ°çš„éªŒè¯ç æ¥ç™»å½•æ‚¨çš„è´¦å·ï¼Œç™»å½•æˆåŠŸåä¼šç”Ÿæˆ`chat_translator.session` æ–‡ä»¶

## ç³»ç»ŸæœåŠ¡

#### **åˆ›å»ºæœåŠ¡**

```bash
sudo bash -c 'cat << EOF > /etc/systemd/system/telegram-translate.service
[Unit]
Description=Telegram Translate Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/etc/telegram-translate
ExecStart=/usr/bin/python3 /etc/telegram-translate/main.py
Restart=on-failure
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF'
```

#### **è¿è¡ŒæœåŠ¡**

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now telegram-translate.service
```

#### æŸ¥çœ‹æ—¥å¿—

```bash
sudo journalctl -u telegram-translate.service
```

## å¼€å§‹ä½¿ç”¨

### å¼€å¯ç¿»è¯‘

å°†ä¸­æ–‡ç¿»è¯‘æˆè‹±æ–‡å’Œä¿„æ–‡å¹¶å¼•ç”¨ä¸­æ–‡åŸæ–‡

```bash
.tt-on,zh,zh|en|ru
```

### å…³é—­ç¿»è¯‘

```bash
.tt-off
```

### æ”¯æŒè¯­è¨€

| **æºè¯­è¨€**                       | **ç›®æ ‡è¯­è¨€** |                                                              |       |
| -------------------------------- | ------------ | ------------------------------------------------------------ | ----- |
| Arabic                           | AR           | Arabic                                                       | AR    |
| Bulgarian                        | BG           | Bulgarian                                                    | BG    |
| Czech                            | CS           | Czech                                                        | CS    |
| Danish                           | DA           | Danish                                                       | DA    |
| German                           | DE           | German                                                       | DE    |
| Greek                            | EL           | Greek                                                        | EL    |
| English                          | EN           | English (unspecified variant for backward compatibility; please select EN-GB or EN-US instead) | EN    |
| Spanish                          | ES           | Spanish                                                      | ES    |
| Estonian                         | ET           | Estonian                                                     | ET    |
| Finnish                          | FI           | Finnish                                                      | FI    |
| French                           | FR           | French                                                       | FR    |
| Hungarian                        | HU           | Hungarian                                                    | HU    |
| Indonesian                       | ID           | Indonesian                                                   | ID    |
| Italian                          | IT           | Italian                                                      | IT    |
| Japanese                         | JA           | Japanese                                                     | JA    |
| Korean                           | KO           | Korean                                                       | KO    |
| Lithuanian                       | LT           | Lithuanian                                                   | LT    |
| Latvian                          | LV           | Latvian                                                      | LV    |
| Norwegian (BokmÃ¥l)               | NB           | Norwegian (BokmÃ¥l)                                           | NB    |
| Dutch                            | NL           | Dutch                                                        | NL    |
| Polish                           | PL           | Polish                                                       | PL    |
| Portuguese (all varieties mixed) | PT           | Portuguese (unspecified variant for backward compatibility; please select PT-BR or PT-PT instead) | PT    |
| Romanian                         | RO           | Romanian                                                     | RO    |
| Russian                          | RU           | Russian                                                      | RU    |
| Slovak                           | SK           | Slovak                                                       | SK    |
| Slovenian                        | SL           | Slovenian                                                    | SL    |
| Swedish                          | SV           | Swedish                                                      | SV    |
| Turkish                          | TR           | Turkish                                                      | TR    |
| Ukrainian                        | UK           | Ukrainian                                                    | UK    |
| Chinese                          | ZH           | Chinese (simplified)                                         | ZH    |
|                                  |              | English (British)                                            | EN-GB |
|                                  |              | English (American)                                           | EN-US |
|                                  |              | Portuguese (Brazilian)                                       | PT-BR |
|                                  |              | Portuguese (excluding Brazilian Portuguese)                  | PT-PT |

## å‚è€ƒé“¾æ¥

[**Telegramå…¨è‡ªåŠ¨ç¿»è¯‘** ](https://linux.do/t/topic/9582)

[**å°†Telegramå…¨è‡ªåŠ¨ç¿»è¯‘æ›´è¿›ä¸€æ­¥**](https://linux.do/t/topic/18308)