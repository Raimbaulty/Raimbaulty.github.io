---
layout: mypost
title: Hedra2API
date: 2025-02-24
published: false
categories: 逆向
tags: 
 - API
---

# Hedra2API

## Cloudflare Worker

```javascript
addEventListener('fetch', event => {
  console.log(`[${new Date().toISOString()}] 收到新请求`)
  event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
  const requestId = generateRequestId()
  console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 收到 ${request.method} 请求，URL: ${request.url}`)
  console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 请求头:`, JSON.stringify(Object.fromEntries([...request.headers])))
  
  // 处理CORS预检请求
  if (request.method === 'OPTIONS') {
    console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 处理OPTIONS预检请求`)
    return new Response(null, {
      status: 200,
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Authorization, Content-Type, X-Requested-With',
        'Access-Control-Max-Age': '86400'
      }
    })
  }

  // 处理正常POST请求
  if (request.method === 'POST') {
    try {
      console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 开始处理POST请求`)
      let requestBody
      try {
        const clonedRequest = request.clone()
        requestBody = await clonedRequest.text()
        console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 原始请求体:`, requestBody)
        const requestData = JSON.parse(requestBody)
        console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 解析后的请求数据:`, JSON.stringify(requestData))
        
        // 验证请求格式
        if (!isValidOpenAIRequest(requestData)) {
          console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 请求格式无效`)
          return corsResponse({
            error: {
              message: "Invalid request format",
              type: "invalid_request_error"
            }
          }, 400)
        }

        // 从OpenAI格式提取绘图提示
        const prompt = extractImagePromptFromOpenAI(requestData)
        console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 提取的绘图提示:`, JSON.stringify(prompt))
        
        // 使用请求中的Authorization头作为Hedra API密钥
        const authHeader = request.headers.get('Authorization') || '';
        console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 验证Authorization头`)
        if (!authHeader || !authHeader.startsWith('Bearer ')) {
          console.error(`[${new Date().toISOString()}][请求ID:${requestId}] Authorization头缺失或格式错误: ${authHeader}`);
          return corsResponse({
            error: {
              message: "Missing or invalid Authorization token",
              type: "auth_error"
            }
          }, 401);
        }
        
        const hedraApiKey = authHeader.split(' ')[1]; // 从Authorization头中获取token
        console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 成功获取Authorization令牌`);
        
        // 第一步 提交绘图任务到Hedra
        console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 开始提交任务到Hedra API`)
        try {
          // 构建Hedra API请求体
          const hedraRequestBody = {
            type: "image",
            ai_model_id: prompt.model_id,
            text_prompt: prompt.prompt,
            aspect_ratio: prompt.aspect_ratio,
            resolution: prompt.resolution
          };
          console.log(`[${new Date().toISOString()}][请求ID:${requestId}] Hedra API请求体:`, JSON.stringify(hedraRequestBody))
          
          const submissionResponse = await submitHedraTask(prompt, hedraApiKey, requestId)
          console.log(`[${new Date().toISOString()}][请求ID:${requestId}] Hedra提交响应:`, JSON.stringify(submissionResponse))
          
          if (!submissionResponse.id) {
            console.error(`[${new Date().toISOString()}][请求ID:${requestId}] Hedra响应缺少ID字段:`, JSON.stringify(submissionResponse))
            return corsResponse({
              error: {
                message: "Invalid response from image API",
                type: "api_error"
              }
            }, 500)
          }
          
          const generationId = submissionResponse.id
          console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 获取到生成ID: ${generationId}`)
          
          // 第二步 监测生成进度
          let generationStatus = "processing"  // 根据日志看到初始状态是processing
          let generationResult = null
          let attempts = 0
          const maxAttempts = 30 // 最多等待30秒
          
          console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 开始轮询生成状态`)
          while ((generationStatus === "queued" || generationStatus === "processing" || generationStatus === "in_progress") && attempts < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 1000)) // 等待1秒
            attempts++
            
            console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 状态检查尝试 ${attempts}/${maxAttempts}`)
            try {
              const statusResponse = await checkHedraTaskStatus(generationId, hedraApiKey, requestId)
              
              // 记录完整响应结构以便调试
              console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 状态响应完整结构:`, JSON.stringify(statusResponse))
              
              generationStatus = statusResponse.status
              const progress = statusResponse.progress || 0
              console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 当前状态: ${generationStatus}, 进度: ${progress * 100}%`)
              
              if (generationStatus === "complete") {
                generationResult = statusResponse
                console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 生成完成`)
                break
              } else if (generationStatus === "failed") {
                const errorMessage = statusResponse.error_message || "Unknown error"
                console.error(`[${new Date().toISOString()}][请求ID:${requestId}] 生成失败: ${errorMessage}`)
                return corsResponse({
                  error: {
                    message: `图片生成失败: ${errorMessage}`,
                    type: "generation_error",
                    code: "GENERATION_FAILED"
                  }
                }, 500)
              } else if (generationStatus === "cancelled") {
                console.error(`[${new Date().toISOString()}][请求ID:${requestId}] 生成任务被取消`)
                return corsResponse({
                  error: {
                    message: "图片生成任务被取消",
                    type: "generation_error",
                    code: "GENERATION_CANCELLED"
                  }
                }, 500)
              } else if (generationStatus === "error") {
                console.error(`[${new Date().toISOString()}][请求ID:${requestId}] 生成过程出错`)
                return corsResponse({
                  error: {
                    message: "图片生成过程出错",
                    type: "generation_error",
                    code: "GENERATION_ERROR"
                  }
                }, 500)
              }
            } catch (statusError) {
              console.error(`[${new Date().toISOString()}][请求ID:${requestId}] 检查状态时出错:`, statusError)
              return corsResponse({
                error: {
                  message: `检查生成状态时出错: ${statusError.message}`,
                  type: "api_error",
                  code: "STATUS_CHECK_ERROR"
                }
              }, 500)
            }
          }
          
          if (attempts >= maxAttempts) {
            console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 生成超时，已尝试 ${attempts} 次`)
            return corsResponse({
              error: {
                message: "图片生成超时，请稍后重试",
                type: "timeout_error",
                code: "GENERATION_TIMEOUT"
              }
            }, 504)
          }
          
          // 处理未完成的生成过程
          if (!generationResult) {
            console.error(`[${new Date().toISOString()}][请求ID:${requestId}] 轮询后没有生成结果`)
            return corsResponse({
              error: {
                message: "未能获取生成结果",
                type: "generation_error",
                code: "NO_RESULT"
              }
            }, 500)
          }
          
          // 检查生成结果是否包含asset
          if (generationResult.asset === null) {
            console.error(`[${new Date().toISOString()}][请求ID:${requestId}] 生成结果中asset为空:`, JSON.stringify(generationResult));
            return corsResponse({
              error: {
                message: "生成未完成，资源尚未就绪，请稍后重试",
                type: "incomplete_generation",
                code: "ASSET_NOT_READY"
              }
            }, 202); // 使用202 Accepted表示任务已接受但未完成
          }
          
          // 构造OpenAI格式的响应
          console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 开始格式化为OpenAI响应格式`)
          const openaiResponse = formatHedraResponseAsOpenAI(generationResult, requestId)
          console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 生成的OpenAI格式响应:`, JSON.stringify(openaiResponse))
          return openaiResponse
        } catch (apiError) {
          console.error(`[${new Date().toISOString()}][请求ID:${requestId}] API请求失败:`, apiError);
          return corsResponse({
            error: {
              message: apiError.message,
              type: "api_error"
            }
          }, 500);
        }
      } catch (parseError) {
        console.error(`[${new Date().toISOString()}][请求ID:${requestId}] 解析请求体失败:`, parseError);
        console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 原始请求体:`, requestBody);
        return corsResponse({
          error: {
            message: `Invalid JSON: ${parseError.message}`,
            type: "json_parse_error"
          }
        }, 400);
      }
    } catch (error) {
      console.error(`[${new Date().toISOString()}][请求ID:${requestId}] 处理请求时出错:`, error)
      return corsResponse({
        error: {
          message: error.message,
          type: "server_error"
        }
      }, 500)
    }
  }
  
  // 其他HTTP方法
  console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 不支持的方法 ${request.method}`)
  return corsResponse({
    error: {
      message: "Method not allowed",
      type: "method_error"
    }
  }, 405)
}

// 生成请求ID
function generateRequestId() {
  return Math.random().toString(36).substring(2, 10);
}

// 创建带CORS头的响应
function corsResponse(body, status = 200) {
  const responseBody = JSON.stringify(body)
  console.log(`[${new Date().toISOString()}] 发送响应，状态码: ${status}，响应体: ${responseBody}`)
  
  const headers = {
    'Content-Type': 'application/json',
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Authorization, Content-Type, X-Requested-With',
    'Cache-Control': 'no-cache',
    'X-Request-ID': requestId || generateRequestId()
  }

  if (status === 202) {
    headers['Retry-After'] = '5' // 建议客户端5秒后重试
  }

  return new Response(responseBody, {
    status: status,
    headers: headers
  })
}

// 检查是否是有效的OpenAI请求
function isValidOpenAIRequest(data) {
  const isValid = data && data.messages && Array.isArray(data.messages)
  console.log(`[${new Date().toISOString()}] OpenAI请求格式验证: ${isValid ? '有效' : '无效'}`)
  return isValid
}

// 从OpenAI请求中提取图片提示
function extractImagePromptFromOpenAI(data) {
  // 查找最后一条用户消息
  const userMessages = data.messages.filter(msg => msg.role === 'user')
  if (userMessages.length === 0) {
    console.error(`[${new Date().toISOString()}] 未找到用户消息`)
    throw new Error("No user message found")
  }
  
  const lastUserMessage = userMessages[userMessages.length - 1]
  console.log(`[${new Date().toISOString()}] 找到最后一条用户消息:`, JSON.stringify(lastUserMessage))
  
  const prompt = {
    prompt: lastUserMessage.content,
    aspect_ratio: data.aspect_ratio || "16:9",
    resolution: data.resolution || "540p",
    model_id: data.model_id || "5064bef6-38e5-4881-812f-4b682ac2cf88" // 默认使用示例中的模型ID
  }
  
  console.log(`[${new Date().toISOString()}] 提取的绘图提示:`, JSON.stringify(prompt))
  return prompt
}

// 提交Hedra绘图任务
async function submitHedraTask(promptData, apiKey, requestId) {
  const hedraUrl = 'https://api.hedra.com/web-app/generations';
  console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 发送请求到Hedra API: ${hedraUrl}`)
  
  const requestBody = JSON.stringify({
    type: "image",
    ai_model_id: promptData.model_id,
    text_prompt: promptData.prompt,
    aspect_ratio: promptData.aspect_ratio,
    resolution: promptData.resolution
  });
  
  console.log(`[${new Date().toISOString()}][请求ID:${requestId}] Hedra请求体: ${requestBody}`)
  
  const response = await fetch(hedraUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey}`
    },
    body: requestBody
  })
  
  const responseStatus = response.status;
  const responseHeaders = Object.fromEntries([...response.headers]);
  console.log(`[${new Date().toISOString()}][请求ID:${requestId}] Hedra响应状态: ${responseStatus}`);
  console.log(`[${new Date().toISOString()}][请求ID:${requestId}] Hedra响应头: ${JSON.stringify(responseHeaders)}`);
  
  if (!response.ok) {
    let errorData;
    try {
      errorData = await response.text();
      console.error(`[${new Date().toISOString()}][请求ID:${requestId}] Hedra API错误: ${errorData}`);
    } catch(e) {
      console.error(`[${new Date().toISOString()}][请求ID:${requestId}] 无法读取错误响应`);
      errorData = "Could not read error response";
    }
    throw new Error(`Hedra API error: ${response.status} - ${errorData}`);
  }
  
  const responseData = await response.json();
  console.log(`[${new Date().toISOString()}][请求ID:${requestId}] Hedra API响应数据: ${JSON.stringify(responseData)}`);
  return responseData;
}

// 检查Hedra任务状态
async function checkHedraTaskStatus(generationId, hedraApiKey, requestId) {
  const statusUrl = `https://api.hedra.com/web-app/generations/${generationId}`;
  console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 检查生成ID ${generationId} 的状态: ${statusUrl}`);
  
  const response = await fetch(statusUrl, {
    headers: {
      'Accept': 'application/json',
      'Authorization': `Bearer ${hedraApiKey}`
    }
  });
  
  const responseStatus = response.status;
  const responseHeaders = Object.fromEntries([...response.headers]);
  console.log(`[${new Date().toISOString()}][请求ID:${requestId}] Hedra状态检查响应状态: ${responseStatus}`);
  console.log(`[${new Date().toISOString()}][请求ID:${requestId}] Hedra状态检查响应头: ${JSON.stringify(responseHeaders)}`);
  
  if (!response.ok) {
    let errorData;
    try {
      errorData = await response.text();
      console.error(`[${new Date().toISOString()}][请求ID:${requestId}] Hedra API状态检查错误: ${errorData}`);
    } catch(e) {
      console.error(`[${new Date().toISOString()}][请求ID:${requestId}] 无法读取错误响应`);
      errorData = "Could not read error response";
    }
    throw new Error(`Hedra API status check error: ${response.status} - ${errorData}`);
  }
  
  const statusData = await response.json();
  console.log(`[${new Date().toISOString()}][请求ID:${requestId}] Hedra状态检查响应: ${JSON.stringify(statusData)}`);
  return statusData;
}

// 将Hedra响应格式化为OpenAI格式
function formatHedraResponseAsOpenAI(hedraResponse, requestId) {
  console.log(`[${new Date().toISOString()}][请求ID:${requestId}] 准备格式化Hedra响应:`, JSON.stringify(hedraResponse));
  
  if (!hedraResponse) {
    console.error(`[${new Date().toISOString()}][请求ID:${requestId}] Hedra响应结构无效(null或undefined)`);
    throw new Error('Empty response from Hedra API');
  }
  
  if (!hedraResponse.asset || !hedraResponse.asset.asset || !hedraResponse.asset.asset.url) {
    console.error(`[${new Date().toISOString()}][请求ID:${requestId}] Hedra响应缺少必要的图片URL字段:`, JSON.stringify(hedraResponse));
    throw new Error('Missing required image URL in Hedra response');
  }

  const imageUrl = hedraResponse.asset.asset.url;
  const width = hedraResponse.asset.asset.width || 960;
  const height = hedraResponse.asset.asset.height || 528;

  // 构造Markdown格式的响应内容
  const markdownResponse = `![Generated Image](${imageUrl})`;
  
  // 创建一个可读流
  const stream = new ReadableStream({
    async start(controller) {
      try {
        // 发送第一个消息，包含基本信息
        const initialChunk = {
          id: `chatcmpl-${Date.now()}`,
          object: "chat.completion.chunk",
          created: Math.floor(Date.now() / 1000),
          model: "hedra-1",
          system_fingerprint: "fp_hedra_v1",
          choices: [{
            index: 0,
            delta: {
              role: "assistant"
            }
          }]
        };
        controller.enqueue(new TextEncoder().encode(`data: ${JSON.stringify(initialChunk)}\n\n`));

        // 发送完整内容
        const contentChunk = {
          id: `chatcmpl-${Date.now()}`,
          object: "chat.completion.chunk",
          created: Math.floor(Date.now() / 1000),
          model: "hedra-1",
          system_fingerprint: "fp_hedra_v1",
          choices: [{
            index: 0,
            delta: {
              content: markdownResponse
            },
            finish_reason: "stop"
          }]
        };
        
        controller.enqueue(new TextEncoder().encode(`data: ${JSON.stringify(contentChunk)}\n\n`));

        // 发送结束标记
        controller.enqueue(new TextEncoder().encode('data: [DONE]\n\n'));
      } catch (error) {
        console.error(`[${new Date().toISOString()}][请求ID:${requestId}] 流式响应生成错误:`, error);
        controller.error(error);
      } finally {
        controller.close();
      }
    }
  });

  return new Response(stream, {
    headers: {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive',
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Authorization, Content-Type, X-Requested-With',
      'X-Accel-Buffering': 'no'
    }
  });
}
```



