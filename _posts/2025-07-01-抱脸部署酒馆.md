---
layout: mypost
title: æŠ±è„¸éƒ¨ç½²é…’é¦†
date: 2025-07-01
published: true
categories: å…è´¹å®¹å™¨
tags: 
 - sillytavern
 - linux
---

## é…ç½®æ–‡ä»¶

- Dockerfile

  ```dockerfile
  FROM node:20-alpine
  
  ARG APP_HOME=/home/node/app
  ENV USER=node
  
  ENV VENV_PATH=/opt/venv
  ENV PATH="$VENV_PATH/bin:$PATH"
  
  WORKDIR ${APP_HOME}
  
  RUN apk add --no-cache \
          tini \
          git \
          python3 \
          bash \
          dos2unix \
          findutils \
          tar \
          gcompat
  
  RUN python3 -m venv $VENV_PATH \
      && pip install --no-cache-dir --upgrade pip \
      && pip install --no-cache-dir huggingface_hub
  
  ENV NODE_ENV=production
  ENV USERNAME="admin"
  ENV PASSWORD="password"
  ENV FORCE_COLOR=1
  ENV GITHUB_NAME=sillytavern
  ENV GITHUB_REPO=sillytavern
  
  RUN git clone --depth=1 https://github.com/${GITHUB_NAME}/${GITHUB_REPO}.git . \
      && npm install --no-audit --no-fund --loglevel=error \
      && npm cache clean --force
  
  COPY config.yaml ./
  COPY entrypoint.sh ./
  RUN dos2unix entrypoint.sh && chmod +x entrypoint.sh
  
  RUN mkdir -p config data plugins logs public/scripts/extensions/third-party \
      && mv config.yaml ./config/ \
      && ln -s ./config/config.yaml config.yaml \
      && chown -R ${USER}:${USER} ${APP_HOME} ${VENV_PATH}
  
  USER ${USER}
  
  EXPOSE 7860
  
  ENTRYPOINT ["tini", "--"]
  
  CMD ["./entrypoint.sh"]
  ```

- entrypoint.sh

  ```bash
  #!/usr/bin/env bash
  set -euo pipefail
  set -a
  
  APP_BASE_DIR="/home/node/app"
  USERNAME="${USERNAME:-admin}"
  PASSWORD="${PASSWORD:-password}"
  HF_TOKEN="${HF_TOKEN:-}"
  DATASET_ID="${DATASET_ID:-}"
  KEEP_BACKUPS="${KEEP_BACKUPS:-10}"
  SYNC_INTERVAL="${SYNC_INTERVAL:-3600}"
  DIRS_TO_BACKUP=( "data" "config" "plugins" "public/scripts/extensions/third-party" )
  
  log() {
    echo "[$(date +'%F %T')] $*"
  }
  
  init_backup() {
    if [[ -n "${DATASET_ID:-}" ]]; then
      log "ğŸ“ ä½¿ç”¨æä¾›çš„ DATASET_ID=${DATASET_ID}"
      return 0
    fi
    if [[ -z "${HF_TOKEN:-}" ]]; then
      log "âš ï¸ æœªè®¾ç½® HF_TOKENï¼Œè·³è¿‡åŒæ­¥ã€‚"
      return 1
    fi
  
    USER_ID=$(python3 <<'PY'
  import os, sys
  from huggingface_hub import HfApi
  try:
      print(HfApi(token=os.getenv("HF_TOKEN")).whoami().get("name"))
  except Exception:
      sys.exit(1)
  PY
    )
    if [[ -z "$USER_ID" ]]; then
      log "âŒ æ— æ³•ä» HF_TOKEN è·å–ç”¨æˆ·åï¼Œè·³è¿‡åŒæ­¥ã€‚"
      return 1
    fi
  
    DATASET_ID="${USER_ID}/data"
    log "âœ… é»˜è®¤ DATASET_ID å·²è®¾ç½®ä¸º ${DATASET_ID}"
  }
  
  prep_repo() {
    log "ğŸ” å‡†å¤‡ HuggingFace ä»“åº“..."
    python3 <<'PY'
  import os
  from huggingface_hub import HfApi
  from huggingface_hub.utils import HfHubHTTPError
  
  api = HfApi(token=os.getenv("HF_TOKEN"))
  repo_id = os.getenv("DATASET_ID")
  try:
      api.repo_info(repo_id=repo_id, repo_type="dataset")
  except HfHubHTTPError as e:
      if e.response.status_code == 404:
          print(f"ä»“åº“ '{repo_id}' æœªæ‰¾åˆ°ã€‚å°†åˆ›å»ºä¸ºç§æœ‰ä»“åº“ã€‚")
          api.create_repo(repo_id=repo_id, repo_type="dataset", private=True)
      else:
          raise
  PY
    log "âœ… ä»“åº“å·²å‡†å¤‡å°±ç»ªã€‚"
  }
  
  restore_latest() {
    log "ğŸ”„ æ£€æŸ¥è¦æ¢å¤çš„å¤‡ä»½..."
    python3 <<'PY'
  import os, sys, tarfile, tempfile
  from huggingface_hub import HfApi
  
  api = HfApi(token=os.getenv("HF_TOKEN"))
  repo_id = os.getenv("DATASET_ID")
  
  files = api.list_repo_files(repo_id=repo_id, repo_type="dataset")
  backups = sorted([f for f in files if f.endswith(".tar.gz")])
  
  if not backups:
      print("æœªæ‰¾åˆ°è¿œç¨‹å¤‡ä»½ã€‚è·³è¿‡æ¢å¤ã€‚")
      sys.exit(0)
  
  latest_backup = backups[-1]
  print(f"æ‰¾åˆ°æœ€æ–°å¤‡ä»½: {latest_backup}ã€‚æ­£åœ¨æ¢å¤...")
  
  with tempfile.TemporaryDirectory() as temp_dir:
      path = api.hf_hub_download(
          repo_id=repo_id,
          filename=latest_backup,
          repo_type="dataset",
          local_dir=temp_dir
      )
      with tarfile.open(path, "r:gz") as t:
          t.extractall(os.getenv("APP_BASE_DIR"))
  PY
    log "âœ… æ¢å¤æ£€æŸ¥å®Œæˆã€‚"
  }
  
  do_backup() {
    local valid_dirs=()
    for dir in "${DIRS_TO_BACKUP[@]}"; do
      if [[ -d "${APP_BASE_DIR}/${dir}" ]]; then
        valid_dirs+=("$dir")
      fi
    done
  
    if [[ ${#valid_dirs[@]} -eq 0 ]]; then
      log "âš ï¸ æ²¡æœ‰æœ‰æ•ˆçš„ç›®å½•å¯ä¾›å¤‡ä»½ï¼Œè·³è¿‡æ­¤å‘¨æœŸã€‚"
      return
    fi
  
    log "â¬†ï¸ å¼€å§‹å¤‡ä»½è¿‡ç¨‹..."
    local ts; ts=$(date +%Y%m%d_%H%M%S)
    local fname="sillytavern_backup_${ts}.tar.gz"
    local tmp_file; tmp_file=$(mktemp)
  
    tar -czf "$tmp_file" -C "$APP_BASE_DIR" "${valid_dirs[@]}"
    
    python3 <<PY
  import os
  from huggingface_hub import HfApi
  api = HfApi(token=os.getenv("HF_TOKEN"))
  repo_id = os.getenv("DATASET_ID")
  print(f"æ­£åœ¨ä¸Šä¼  {os.path.basename("$fname")}...")
  api.upload_file(
      path_or_fileobj="$tmp_file",
      path_in_repo="$fname",
      repo_id=repo_id,
      repo_type="dataset"
  )
  print("æ­£åœ¨æ¸…ç†æ—§å¤‡ä»½...")
  files = api.list_repo_files(repo_id=repo_id, repo_type="dataset")
  backups = sorted([f for f in files if f.endswith(".tar.gz")])
  keep = int(os.getenv("KEEP_BACKUPS", "10"))
  if len(backups) > keep:
      for old_backup in backups[:-keep]:
          print(f"æ­£åœ¨åˆ é™¤æ—§å¤‡ä»½: {old_backup}")
          api.delete_file(path_in_repo=old_backup, repo_id=repo_id, repo_type="dataset")
      api.super_squash_history(repo_id=repo_id, repo_type="dataset")
  PY
    rm -f "$tmp_file"
    log "âœ… å¤‡ä»½å‘¨æœŸå®Œæˆã€‚"
  }
  
  sync_loop() {
    while true; do
      do_backup
      log "â³ ä¸‹æ¬¡åŒæ­¥å°†åœ¨ ${SYNC_INTERVAL} ç§’åè¿›è¡Œã€‚"
      sleep "${SYNC_INTERVAL}"
    done
  }
  
  main() {
    cd "$APP_BASE_DIR" || { log "âŒ è‡´å‘½é”™è¯¯: æ— æ³•è®¿é—® APP_BASE_DIR ä½äº $APP_BASE_DIR"; exit 1; }
    
    trap 'kill 0' SIGTERM SIGINT
  
    log "ğŸš€ sillytavern å¯åŠ¨å™¨æ­£åœ¨å¯åŠ¨..."
  
    if [[ -f "config/config.yaml" ]]; then
      sed -i -e "s/username: .*/username: \"${USERNAME}\"/" \
             -e "s/password: .*/password: \"${PASSWORD}\"/" "config/config.yaml"
    fi
  
    if init_backup; then
      log "ğŸ”— å·²ä¸ºä»“åº“å¯ç”¨åŒæ­¥æœåŠ¡: $DATASET_ID"
      prep_repo
      restore_latest
      sync_loop &
    fi
  
    log "ğŸŸ¢ æ­£åœ¨å¯åŠ¨ sillytavern æœåŠ¡å™¨..."
    exec node server.js --listen "$@"
  }
  
  main "$@"
  ```

- config.yaml

  ```yaml
  dataRoot: ./data
  listen: true
  listenAddress:
    ipv4: 0.0.0.0
    ipv6: '[::]'
  protocol:
      ipv4: true
      ipv6: false
  dnsPreferIPv6: false
  browserLaunch:
    enabled: true
    browser: 'default'
    hostname: 'auto'
    port: -1
    avoidLocalhost: false
  port: 7860
  ssl:
    enabled: false
    certPath: "./certs/cert.pem"
    keyPath: "./certs/privkey.pem"
  whitelistMode: false
  enableForwardedWhitelist: true
  whitelist:
    - ::1
    - 127.0.0.1
  whitelistDockerHosts: true
  basicAuthMode: true
  basicAuthUser:
    username: "user"
    password: "password"
  enableCorsProxy: false
  requestProxy:
    enabled: false
    url: "socks5://username:password@example.com:1080"
    bypass:
      - localhost
      - 127.0.0.1
  enableUserAccounts: false
  enableDiscreetLogin: false
  autheliaAuth: false
  perUserBasicAuth: false
  sessionTimeout: -1
  disableCsrfProtection: false
  securityOverride: false
  logging:
    enableAccessLog: true
    minLogLevel: 0
  rateLimiting:
    preferRealIpHeader: false
  backups:
    common:
      numberOfBackups: 50
    chat:
      enabled: true
      checkIntegrity: true
      maxTotalBackups: -1
      throttleInterval: 10000
  thumbnails:
    enabled: true
    format: "jpg"
    quality: 95
    dimensions: { 'bg': [160, 90], 'avatar': [96, 144] }
  performance:
    lazyLoadCharacters: false
    memoryCacheCapacity: '100mb'
    useDiskCache: true
  allowKeysExposure: false
  skipContentCheck: false
  whitelistImportDomains:
    - localhost
    - cdn.discordapp.com
    - files.catbox.moe
    - raw.githubusercontent.com
    - char-archive.evulid.cc
  requestOverrides: []
  extensions:
    enabled: true
    autoUpdate: true
    models:
      autoDownload: true
      classification: Cohee/distilbert-base-uncased-go-emotions-onnx
      captioning: Xenova/vit-gpt2-image-captioning
      embedding: Cohee/jina-embeddings-v2-base-en
      speechToText: Xenova/whisper-small
      textToSpeech: Xenova/speecht5_tts
  enableDownloadableTokenizers: true
  promptPlaceholder: "[Start a new chat]"
  openai:
    randomizeUserId: false
    captionSystemPrompt: ""
  deepl:
    formality: default
  mistral:
    enablePrefix: false
  ollama:
    keepAlive: -1
    batchSize: -1
  claude:
    enableSystemPromptCache: false
    cachingAtDepth: -1
    extendedTTL: false
  gemini:
    apiVersion: 'v1beta'
  enableServerPlugins: false
  enableServerPluginsAutoUpdate: true
  ```

  

## ç¯å¢ƒå˜é‡

| å˜é‡å        | ç¤ºä¾‹å€¼          | æè¿°                     |
| ------------- | --------------- | ------------------------ |
| USERNAME      | user            | å¿…å¡«ï¼Œç™»å½•ç”¨æˆ·å         |
| PASSWORD      | password        | å¿…å¡«ï¼Œç™»å½•å¯†ç            |
| HF_TOKEN      | hf_************ | å¿…å¡«ï¼ŒHuggingFaceä»¤ç‰Œ    |
| SYNC_INTERVAL | 36000           | é€‰å¡«ï¼ŒåŒæ­¥é—´éš”ï¼Œå•ä½ï¼šç§’ |

