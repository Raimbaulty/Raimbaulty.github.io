---
layout: mypost
title: åœ¨è½»é‡çº§æœåŠ¡å™¨æ­å»ºHalo
date: 2024-11-13
published: true
categories: åšå®¢
tags: 
 - blog
---

## åšå®¢é…ç½®

1c-1g-30G/postgres+halo

## æ­å»ºæ­¥éª¤

### é…ç½®ç¯å¢ƒ

æˆªæ­¢åšå®¢æ›´æ–°æ—¶ï¼Œ Halo è¦æ±‚ **JRE ç‰ˆæœ¬ â‰¥ 17**ï¼Œ[å‰å¾€å®˜ç½‘](https://jdk.java.net/archive/) ä¸‹è½½æœ€æ–°ç‰ˆæœ¬

1. **ä¸‹è½½java**
    ```
    wget -qO- https://download.java.net/java/GA/jdk23/3c5b90190c68498b986a97f276efd28a/37/GPL/openjdk-23_linux-x64_bin.tar.gz | sudo tar -xz -C /opt/
    ```
    
2. **æ›´æ–°ç¯å¢ƒå˜é‡**
    ```
    sudo cat <<EOF >> /etc/profile
    export JAVA_HOME=/opt/jdk-23
    export PATH=\$PATH:\$JAVA_HOME/bin
    EOF
    ```

3. **æ›´æ–°ç³»ç»Ÿé»˜è®¤Javaç‰ˆæœ¬**

    ```
    sudo update-alternatives --install /usr/bin/java java /opt/jdk-23/bin/java 1
    sudo update-alternatives --install /usr/bin/javac javac /opt/jdk-23/bin/javac 1
    ```

4. **æ£€æŸ¥æ˜¯å¦é…ç½®æ­£ç¡®**

    ```
    sudo update-alternatives --config java
    sudo update-alternatives --config javac
    java -version
    ```

### é…ç½®æ•°æ®åº“

1. **å®‰è£…postgres**

   ```bash
   sudo apt update
   sudo apt install postgresql postgresql-contrib
	```

2. **ä¼˜åŒ–é…ç½®æ–‡ä»¶**
   ```bash
   sudo vi /etc/postgresql/{version}/main/postgresql.conf 
	```

	ä¿®æ”¹ä»¥ä¸‹é…ç½®é¡¹ 

   ```ini
   shared_buffers = 32MB
   work_mem = 1MB
   maintenance_work_mem = 16MB
   autovacuum = on
   ```

3. **åˆ›å»ºæ•°æ®åº“**

   ```bash
   sudo -u postgres psql
   ```
   
   ````sql
   CREATE DATABASE halo;
   CREATE USER halo_user WITH PASSWORD 'secure_password';
   ALTER ROLE halo_user SET client_encoding TO 'utf8';
   ALTER ROLE halo_user SET default_transaction_isolation TO 'read committed';
   ALTER ROLE halo_user SET timezone TO 'UTC';
   GRANT ALL PRIVILEGES ON DATABASE halo TO halo_user;
   \q
   ````

### é…ç½®halo

1. **åˆ›å»ºç”¨æˆ·ç›®å½•**

   ```bash
   useradd -m halo
   passwd halo
   su - halo
   ```

2. **ä¸‹è½½halo.jar**

   åœ¨ ~/app ç›®å½•ä¸‹è½½halo æœ€æ–°ç‰ˆæœ¬çš„è¿è¡ŒåŒ…ï¼Œæˆªæ­¢åšå®¢æ›´æ–°æ—¶ï¼Œæœ€æ–°ç‰ˆæœ¬ v2.20.11ï¼Œç‚¹å‡»å‰å¾€ [å‘å¸ƒé¡µ](https://github.com/halo-dev/halo/releases)

   ```bash
   mkdir ~/app && curl -s https://api.github.com/repos/halo-dev/halo/releases/latest | grep "browser_download_url" | grep "\.jar\"" | cut -d '"' -f 4 | xargs curl -L -o ~/app/halo.jar
   ```

3. **åˆ›å»ºé…ç½®æ–‡ä»¶**

   ```yaml
   mkdir ~/.halo2 && cd ~/.halo2
   vim application.yaml
   
   server:
   
     # è¿è¡Œç«¯å£
   
     port: 8080
   spring:
     r2dbc:
       url: r2dbc:pool:postgresql://localhost:5432/halo
       username: halo
       password: biubiubiu
     sql:
       init:
         mode: always
         platform: postgresql
   halo:
     caches:
       page:
         # æ˜¯å¦ç¦ç”¨é¡µé¢ç¼“å­˜
         disabled: false
   
     # å·¥ä½œç›®å½•ä½ç½®
   
     work-dir: ${user.home}/.halo2
   
     # å¤–éƒ¨è®¿é—®åœ°å€
   
     external-url: http://localhost:8080
   
     # é™„ä»¶æ˜ å°„é…ç½®ï¼Œé€šå¸¸ç”¨äºè¿ç§»åœºæ™¯
   
     attachment:
       resource-mappings:
         - pathPattern: /upload/**
           locations:
             - migrate-from-1.x
   ```

4. **æµ‹è¯•è¿è¡Œ**

   ```bash
   cd ~/app && java -Dfile.encoding=UTF-8 -jar halo.jar --spring.config.additional-location=optional:file:$HOME/.halo2/
   ```

æ‰“å¼€ http://ip:8080 å³å¯è·³è½¬åˆ°åˆå§‹åŒ–é¡µé¢

### **é…ç½®ç³»ç»ŸæœåŠ¡**

1. **åˆ‡æ¢å›rootç”¨æˆ·åˆ›å»º halo.service**

   ```bash
   exit
   vim /etc/systemd/system/halo.service
   
   [Unit]
   Description=Halo Service
   Documentation=https://docs.halo.run
   After=network-online.target
   Wants=network-online.target
   
   [Service]
   Type=simple
   User=halo
   ExecStart=/usr/bin/java -Dfile.encoding=UTF-8 -server -Xms128m -Xmx192m -Xss256k -XX:+UseSerialGC -jar /home/halo/app/halo.jar --spring.config.additional-location=optional:file:/home/halo/.halo2/
   ExecStop=/bin/kill -s QUIT $MAINPID
   Restart=always
   RestartSec=60
   RuntimeMaxSec=259200
   OOMScoreAdjust=500
   StandardOutput=journal
   StandardError=inherit
   
   [Install]
   WantedBy=multi-user.target
   ```

2. **è¿è¡ŒæœåŠ¡**

   ```bash
   sudo systemctl daemon-reload
   sudo systemctl start halo
   sudo systemctl enable halo
   ```

3. **æŸ¥çœ‹æ—¥å¿—**

   ```bash
   journalctl -n 20 -u halo
   ```

### é…ç½®nginx

1. **ä¸‹è½½è¯ä¹¦**

   å‰å¾€ [ZeroSSL](https://app.zerossl.com/) ä¸‹è½½90å¤©è¯ä¹¦å¹¶å°†è¯ä¹¦è§£å‹åˆ° /etc/nginx/ssl/domain.com

2. **æ›¿æ¢ /etc/nginx/nginx.conf**

   ```nginx
   user www-data;
   worker_processes 1;
   pid /run/nginx.pid;
   
   worker_rlimit_nofile 4096;
   
   events {
       worker_connections 1024;
       use epoll;
   }
   
   http {
       sendfile on;
       tcp_nopush on;
       tcp_nodelay on;
       keepalive_timeout 30;
       types_hash_max_size 1024;
       client_max_body_size 128m;
       server_tokens off;
   
       include /etc/nginx/mime.types;
       default_type application/octet-stream;
       
       access_log off;
       error_log /var/log/nginx/error.log;
       
       ssl_protocols TLSv1.2 TLSv1.3;
       ssl_prefer_server_ciphers on;
       ssl_session_cache shared:SSL:5m;
       ssl_session_timeout 10m;
       
       ssl_stapling on;
       ssl_stapling_verify on;
       resolver 8.8.8.8 8.8.4.4 valid=300s;
       resolver_timeout 5s;
       
       open_file_cache max=500 inactive=10s;
       open_file_cache_valid 20s;
       open_file_cache_min_uses 1;
       open_file_cache_errors on;
       
       server {
           listen 80;
           server_name domain.com;
           return 301 https://$host$request_uri;
       }
       
       server {
           listen 443 ssl;
           http2 on;
           server_name domain.com;
       
           ssl_certificate /etc/nginx/ssl/domain.com/certificate.crt;
           ssl_certificate_key /etc/nginx/ssl/domain.com/private.key;
           ssl_trusted_certificate /etc/nginx/ssl/domain.com/ca_bundle.crt;
       
           ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
       
           add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
           add_header X-Frame-Options SAMEORIGIN;
           add_header X-Content-Type-Options nosniff;
           add_header X-XSS-Protection "1; mode=block";
       
           location / {
               proxy_pass http://localhost:8080;
               proxy_http_version 1.1;
               proxy_set_header Upgrade $http_upgrade;
               proxy_set_header Connection 'upgrade';
               proxy_set_header Host $host;
               proxy_set_header X-Real-IP $remote_addr;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               proxy_set_header X-Forwarded-Proto $scheme;
               proxy_buffering on;
               proxy_buffer_size 64k;
               proxy_buffers 4 128k;
               proxy_busy_buffers_size 128k;
               proxy_connect_timeout 30s;
               proxy_send_timeout 30s;
               proxy_read_timeout 30s;
           }
       }
   
   }
   ```

### å¤‡ä»½å’Œæ¢å¤

è¿›å…¥åå°ï¼Œç‚¹å‡»å·¦ä¾§ **å¤‡ä»½** - **\+ åˆ›å»ºå¤‡ä»½**ï¼Œå¤‡ä»½åä¾æ¬¡ç‚¹å‡»å³ä¾§ **Â·Â·Â·** - **ä¸‹è½½** ä¸‹è½½åˆ°æœ¬åœ°

è¿›å…¥åå°ï¼Œç‚¹å‡»å·¦ä¾§ **å¤‡ä»½** - **æ¢å¤** - **æˆ‘å·²é˜…è¯»ä¸Šæ–¹æç¤ºï¼Œå¼€å§‹æ¢å¤**ï¼Œé€‰æ‹©å¤‡ä»½æ–‡ä»¶è¿›è¡Œæ¢å¤

### æ›´æ–°

ä¸ºé¿å…ç ´åæ€§æ›´æ–°ï¼Œå»ºè®®ç­‰å¾…æ–°ç‰ˆæœ¬å‘å¸ƒä¸€å‘¨åå†è€ƒè™‘æ›´æ–°ï¼Œæ›´æ–°å‰å…ˆåœæ­¢æœåŠ¡

1. **åœæ­¢æœåŠ¡**

   ```bash
   sudo systemctl stop halo
   ```

2. **ä¸‹è½½jaråŒ…**

   åˆ‡æ¢åˆ° halo ç”¨æˆ·ï¼Œåœ¨ ~/app ç›®å½•ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„ Halo è¿è¡ŒåŒ…ï¼Œè¦†ç›–åŸæœ‰çš„è¿è¡ŒåŒ…

   ```bash
   su halo
   curl -s https://api.github.com/repos/halo-dev/halo/releases/latest | grep "browser_download_url" | grep "\.jar\"" | cut -d '"' -f 4 | xargs curl -L -o ~/app/halo.jar
   ```

3. **é‡å¯æœåŠ¡**

   åˆ‡æ¢å›ç®¡ç†å‘˜ç”¨æˆ·æ‰§è¡Œé‡å¯

    ```bash
   exit
   sudo systemctl start halo
    ```

## ç•ªå¤–ä¸€ï¼šé…ç½®UmamiæœåŠ¡

[Umami]([https://github.com/umami-software/umami](https://github.com/umami-software/umami)) æ˜¯ä¸€æ¬¾å¼€æºçš„ç±» Google Analytics å·¥å…·ï¼ŒHalo å·²ç»æä¾›äº†æ’ä»¶æ”¯æŒï¼Œå¯ç›´æ¥åœ¨æ’ä»¶å¸‚åœºæœç´¢å®‰è£…æ’ä»¶æ­é… Umami æœåŠ¡ä½¿ç”¨

### å®¹å™¨éƒ¨ç½²

ä½¿ç”¨ renderã€koyebè¿™æ ·çš„å…è´¹å®¹å™¨éƒ¨ç½²ï¼Œå…‹éš†ä»“åº“ï¼šhttps://github.com/Raimbaulty/umami åè¿æ¥åˆ°ä»“åº“

#### ç¯å¢ƒå˜é‡

| å˜é‡åç§°            | ç¤ºä¾‹å€¼                                    | æè¿°                                            |
| ------------------- | ----------------------------------------- | ----------------------------------------------- |
| ALLOWED_FRAME_URLS  | `https://example.com,https://domain.com`  | å…è®¸åµŒå…¥çš„ç«™ç‚¹åœ°å€ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”              |
| APP_SECRET          | `your_app_secret_key`                     | åº”ç”¨å®‰å…¨å¯†é’¥ï¼ŒåŠ¡å¿…ä¿å¯†                          |
| DATABASE_TYPE       | `postgres`                                | æ•°æ®åº“ç±»å‹ï¼Œå¦‚ `mysql`, `postgres`, `sqlite` ç­‰ |
| DATABASE_URL        | `postgresql://user:password@host:port/db` | æ•°æ®åº“è¿æ¥ URL                                  |
| TRACKER_SCRIPT_NAME | `index.js`                                | è‡ªå‘½åè¿½è¸ªè„šæœ¬ï¼Œé˜²æ­¢è¢«å¹¿å‘Šæ‹¦æˆªæ’ä»¶æ‹¦æˆª          |

#### æ·»åŠ ç«™ç‚¹

æœåŠ¡è¿è¡Œåï¼Œè®¿é—®å®¹å™¨åœ°å€ä½¿ç”¨é»˜è®¤ç”¨æˆ·å `admin` é»˜è®¤å¯†ç  `umami`ç™»å½•ï¼Œç‚¹å‡»å³ä¸Šè§’ ğŸŒ åˆ‡æ¢è¯­è¨€ä¸ºä¸­æ–‡

å¯¼èˆªæ ç‚¹å‡» **è®¾ç½®** â†’ **+ æ·»åŠ ç½‘ç«™**ï¼Œå¡«å†™ç½‘ç«™åç§°å’ŒåŸŸåï¼ˆä¸å¸¦ `https://` åè®®å¤´ï¼‰å **ä¿å­˜**

ç‚¹å‡» **ç¼–è¾‘**ï¼Œé¦–å…ˆå¤åˆ¶ **ç½‘ç«™ ID** ä¿å­˜ï¼Œç„¶ååˆ‡æ¢åˆ° **å…±äº«é“¾æ¥** æ ‡ç­¾ï¼Œæ‰“å¼€ **å¯ç”¨å…±äº«é“¾æ¥** å¹¶å¤åˆ¶ `Your website stats are publicly available at the following URL:` çš„å€¼ä½œä¸ºä¸‹ä¸€æ­¥ **å…±äº«é“¾æ¥** çš„å€¼å¡«å…¥

#### é…ç½®æ’ä»¶

åœ¨åº”ç”¨å¸‚åœºæœç´¢ Umami å¹¶å®‰è£…ï¼Œç„¶ååœ¨ **æ’ä»¶** å¼€å¯ Umami å¹¶ç‚¹å‡» Â·Â·Â· è¿›å…¥ **è¯¦æƒ…**ï¼Œåˆ‡æ¢åˆ° **è®¾ç½®** æ ‡ç­¾è¿›è¡Œè®¾ç½®

- **Umami ç«™ç‚¹åœ°å€** å¡«å†™å®¹å™¨åœ°å€
- **è„šæœ¬åç§°** å¡«å†™ä¸ `TRACKER_SCRIPT_NAME` ä¿æŒä¸€è‡´
- **ç«™ç‚¹ ID** å¡«å†™ä¸Šä¸€æ­¥å¤åˆ¶çš„ **ç½‘ç«™ ID**
- **å…±äº«é“¾æ¥** å¡«å†™ä¸Šä¸€æ­¥å¾—åˆ°çš„å€¼

### ä¼ ç»Ÿéƒ¨ç½²

#### é…ç½®ç¯å¢ƒ

```bash
su - halo
curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash
source ~/.profile
nvm install 18
nvm use 18
npm install -g yarn
```

#### é…ç½®æ•°æ®åº“

```bash
sudo -u postgres psql
```

```sql
CREATE DATABASE umami;
CREATE USER umami_user WITH PASSWORD 'secure_password';
ALTER ROLE umami_user SET client_encoding TO 'utf8';
ALTER ROLE umami_user SET default_transaction_isolation TO 'read committed';
ALTER ROLE umami_user SET timezone TO 'UTC';
GRANT ALL PRIVILEGES ON DATABASE umami TO umami_user;
\q
```

#### é…ç½®umami

```bash
su - halo
git clone https://github.com/umami-software/umami.git umami && cd $_
cat > .env <<EOF
DATABASE_URL=postgresql://umami_user:secure_password@localhost:5432/umami
EOF
yarn install
yarn build
```

å¦‚æœæ˜¯1C1Gçš„è½»é‡æœºï¼Œå…ˆç»ˆæ­¢å…¶ä»–æœåŠ¡é‡Šæ”¾å†…å­˜ç„¶åæ‰§è¡Œä¸‹é¢çš„æŒ‡ä»¤æ„å»º

```bash
NODE_OPTIONS="--max-old-space-size=1024" yarn build
```

#### é…ç½®æœåŠ¡

```bash
sudo cat <<EOF > /etc/systemd/system/umami.service
[Unit]
Description=Umami Service
After=network.target

[Service]
Type=simple
User=halo
ExecStart=/home/halo/.nvm/versions/node/v18.20.7/bin/yarn start
Restart=always
Environment=PATH=/usr/bin:/usr/local/bin:/home/halo/.nvm/versions/node/v18.20.7/bin
Environment=NODE_ENV=production
WorkingDirectory=/home/halo/umami

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl start umami
sudo systemctl enable umami
sudo systemctl status umami
```

#### é…ç½®nginx

æ³¨æ„æ›¿æ¢`umami.com`ä¸ºumamiç«™ç‚¹åœ°å€ï¼Œ`domain.com`ä¸ºhaloç«™ç‚¹åœ°å€

```nginx
server {
  listen 80;
  listen [::]:80;

  server_name umami.com;
  
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  server_name umami.com;

  ssl on;
  ssl_certificate      /etc/nginx/cert/umami.com/certificate.crt;
  ssl_certificate_key  /etc/nginx/cert/umami.com/private.key;
  ssl_trusted_certificate /etc/nginx/ssl/umami.com/ca_bundle.crt;

  add_header Access-Control-Allow-Origin 'https://[halo.domain.com]';
  add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
  add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
  if ($request_method = 'OPTIONS') {
    return 204;
  }
  add_header Content-Security-Policy 'frame-ancestors domain.com'; 
  location / {
    proxy_pass http://localhost:3000;
    proxy_set_header HOST $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_hide_header 'Access-Control-Allow-Origin';
    proxy_hide_header 'Content-Security-Policy';
  }
}
```

#### æ›´æ–°

```bash
sudo systemctl stop umami
su - halo && cd umami
git pull
yarn install
yarn build
sudo systemctl start umami
```

## ç•ªå¤–äºŒï¼šéƒ¨ç½²Huggingfaceå¤‡ä»½

**ä»¥ä¸‹æ•™ç¨‹ä½¿ç”¨ H2 æ•°æ®åº“ï¼Œåªå»ºè®®ç”¨ä½œåšå®¢å¤‡ä»½**

### åˆ›å»ºç©ºé—´

[ç‚¹å‡»è¿™é‡Œ](https://huggingface.co/new-space) åˆ›å»ºï¼Œspace name å¡«å†™ haloï¼ŒLicense é€‰æ‹© Apache2.0ï¼Œç‚¹å‡» Docker - Blankï¼Œç¡®è®¤å‹¾é€‰ Publicï¼Œç„¶åç‚¹å‡» Create Space åˆ›å»º

ç©ºé—´åˆ›å»ºåï¼Œéœ€è¦ä¿®æ”¹æˆ–åˆ›å»ºä»¥ä¸‹æ–‡ä»¶ï¼Œ`.gitattributes` æ— éœ€ä¿®æ”¹

```
ğŸ“¦ main
â”œâ”€â”€ ğŸ“„ .gitattributes
â”œâ”€â”€ ğŸ“„ Dockerfile
â”œâ”€â”€ ğŸ“„ sync_data.sh
â””â”€â”€ ğŸ“„ README.md
```

ä¸‹é¢ä¾æ¬¡ä»‹ç»é™¤ `.gitattributes` å¤–å„æ–‡ä»¶é…ç½®

### é…ç½®Dockerfile

- ç‚¹å‡» **Files** èœå• - **\+ Add file** - **Create a new file**

- Name your file å¡«å†™`Dockerfile` ï¼Œå¹¶å°†ä»¥ä¸‹ä»£ç å¤åˆ¶åˆ° **Edit** ä¸‹æ–¹åç‚¹å‡» **Commit changes to** `main` æäº¤

  ```dockerfile
  FROM eclipse-temurin:23-jre
    
  WORKDIR /opt/halo
    
  ENV TZ=Asia/Shanghai
  ENV JVM_OPTS="-Xmx256m -Xms256m"
    
  RUN apt-get update && \
      apt-get install -y curl python3 python3-venv python3-pip tar zip  && \
      apt-get clean && \
      rm -rf /var/lib/apt/lists/*
    
  RUN curl -s https://api.github.com/repos/halo-dev/halo/releases/latest | grep "browser_download_url" | grep "\.jar\"" | cut -d '"' -f 4 | xargs curl -L -o halo.jar
    
  RUN mkdir -p ~/.halo2
    
  ENV VIRTUAL_ENV=/opt/venv
  RUN python3 -m venv $VIRTUAL_ENV
  ENV PATH="$VIRTUAL_ENV/bin:$PATH"
  RUN pip install --no-cache-dir huggingface_hub
  
  COPY sync_data.sh /opt/halo/
  RUN chmod +x /opt/halo/sync_data.sh
    
  EXPOSE 8090
  
  CMD ["bash", "-c", "exec /opt/halo/sync_data.sh"]
  ```

### é…ç½®sync\_data.sh

- æ“ä½œåŒä¸Šï¼ŒName your file å¡«å†™`sync_data.sh` ï¼Œå¤åˆ¶ä¸‹æ–¹ä»£ç åç‚¹å‡» **Commit changes to** `main` æäº¤

  ```sh
  #!/usr/bin/env bash
  set -euo pipefail
  IFS=$'\n\t'
  
  set -a
  
  log() {
    echo "[$(date +'%F %T')] $*"
  }
  
  init_backup(){
    if [[ -n "${DATASET_ID:-}" ]]; then
      log "ğŸ“ ä½¿ç”¨å¤–éƒ¨å®šä¹‰çš„ DATASET_ID=$DATASET_ID"
      return 0
    fi
    if [[ -z "${HF_TOKEN:-}" ]]; then
      log "âš ï¸ HF_TOKEN æœªè®¾ç½®ï¼Œè·³è¿‡å¤‡ä»½"
      return 1
    fi
  
    USER_ID=$(python3 - <<'PY'
  import os,sys
  from huggingface_hub import HfApi
  try:
      name = HfApi(token=os.getenv("HF_TOKEN")).whoami().get("name","")
      print(name) if name else sys.exit(1)
  except:
      sys.exit(1)
  PY
    )
    if [[ -z "$USER_ID" ]]; then
      log "âš ï¸ è·å– USER_ID å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
      return 1
    fi
  
    DATASET_ID="${USER_ID}/data"
    # â† è¿™é‡Œä¿®æ­£äº†å˜é‡å
    log "âœ… è®¾ç½®é»˜è®¤ DATASET_ID=$DATASET_ID"
    return 0
  }
  
  prep_repo(){
    python3 <<'PY'
  import os
  from huggingface_hub import HfApi
  api = HfApi(token=os.getenv("HF_TOKEN"))
  repo = os.environ["DATASET_ID"]
  author = repo.split("/")[0]
  if not any(d.id == repo for d in api.list_datasets(author=author)):
      api.create_repo(repo_id=repo, repo_type="dataset", private=True)
  branch = "main"
  refs = api.list_repo_refs(repo_id=repo, repo_type="dataset").branches
  if branch not in [b.name for b in refs]:
      api.create_branch(repo_id=repo, repo_type="dataset", branch=branch)
  PY
    log "âœ… æ•°æ®é›† & åˆ†æ”¯å°±ç»ª"
  }
  
  restore_latest(){
    python3 <<'PY'
  import os,sys,tarfile,tempfile
  from huggingface_hub import HfApi
  api = HfApi(token=os.getenv("HF_TOKEN"))
  repo, branch = os.getenv("DATASET_ID"), "main"
  files = api.list_repo_files(repo_id=repo, repo_type="dataset", revision=branch)
  backs = sorted(f for f in files if f.endswith(".tar.gz"))
  if not backs: sys.exit(0)
  td = tempfile.mkdtemp()
  path = api.hf_hub_download(repo_id=repo, repo_type="dataset",
      revision=branch, filename=backs[-1], local_dir=td)
  with tarfile.open(path) as t:
      t.extractall(os.getenv("BACKUP_DIR"))
  PY
    log "âœ… æ¢å¤æœ€æ–°å¤‡ä»½ï¼ˆå¦‚æœæœ‰ï¼‰"
  }
  
  do_backup(){
    ts=$(date +%Y%m%d_%H%M%S)
    fname="Backup_${ts}.tar.gz"
    tmp=$(mktemp -d)
    tar -czf "$tmp/$fname" -C "$BACKUP_DIR" .
  
    python3 <<PY
  import os
  from huggingface_hub import HfApi
  api = HfApi(token=os.getenv("HF_TOKEN"))
  repo, branch = os.getenv("DATASET_ID"), "main"
  api.upload_file(path_or_fileobj="$tmp/$fname",
                  path_in_repo="$fname",
                  repo_id=repo, repo_type="dataset",
                  revision=branch)
  keep = int(os.getenv("DATASET_NUM", "10"))
  files = api.list_repo_files(repo_id=repo, repo_type="dataset", revision=branch)
  backs = sorted(f for f in files if f.endswith(".tar.gz"))
  for old in backs[:-keep]:
      api.delete_file(path_in_repo=old,
                      repo_id=repo, repo_type="dataset", revision=branch)
  api.super_squash_history(repo_id=repo, repo_type="dataset", branch=branch)
  PY
  
    rm -rf "$tmp"
    log "âœ… ä¸Šä¼ å¤‡ä»½å¹¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
  }
  
  sync_loop(){
    while true; do
      do_backup
      log "â³ ä¸‹æ¬¡åŒæ­¥åœ¨ ${SYNC_INTERVAL}s å"
      sleep "${SYNC_INTERVAL}"
    done
  }
  
  main(){
    BACKUP_DIR="${BACKUP_DIR:-$HOME/.halo2}"
    DATASET_NUM="${DATASET_NUM:-10}"
    SYNC_INTERVAL="${SYNC_INTERVAL:-36000}"
  
    if init_backup; then
      log "ğŸš€ å¯åŠ¨å¤‡ä»½/åŒæ­¥æµç¨‹ï¼Œä½¿ç”¨æ•°æ®é›†ï¼š$DATASET_ID"
      prep_repo
      restore_latest
      sync_loop &    # åå°
    else
      log "ğŸš€ ç›´æ¥å¯åŠ¨ä¸»åº”ç”¨ï¼Œæ— å¤‡ä»½/åŒæ­¥"
    fi
  
    exec java ${JVM_OPTS} -jar /opt/halo/halo.jar
  }
  
  main
  ```

### é…ç½®README.md

- ç‚¹å‡» **Files** èœå•ï¼Œç‚¹å‡» **README.md** è¿›å…¥æ–‡ä»¶è¯¦æƒ…

- ç‚¹å‡» edit ç¼–è¾‘æ–‡ä»¶ï¼Œæ·»åŠ  **app\_aport** åç‚¹å‡» **Commit changes to** `main` æäº¤

  ```markdown
  ---
  title: Halo
  emoji: ğŸŒ
  colorFrom: pink
  colorTo: red
  sdk: docker
  pinned: false
  license: apache-2.0
  app_port: 8090
  ---
  ```

### æ·»åŠ Secrets

ç‚¹å‡» **Settings** èœå•ï¼Œä¸‹æ»‘æ‰¾åˆ°å¹¶ç‚¹å‡»`New secret` æŒ‰é’®

- å¿…å¡«é¡¹

| å˜é‡å   | ç¤ºä¾‹å€¼            | æè¿°                                                         |
| -------- | ----------------- | ------------------------------------------------------------ |
| HF_TOKEN | hf_xxxxxxxxxxxxxx | Huggingfaceä»¤ç‰Œï¼š[å‰å¾€åˆ›å»º](https://huggingface.co/settings/tokens) |

- å¯å¡«é¡¹ï¼Œé»˜è®¤å€¼å¦‚ä¸‹ï¼Œä¸€éƒ¨æ— éœ€è‡ªå®šä¹‰

| å˜é‡å        | ç¤ºä¾‹å€¼       | æè¿°              |
| ------------- | ------------ | ----------------- |
| DATASET_ID    | Owner/data   | æ•°æ®é›†åœ°å€        |
| SYNC_INTERVAL | 36000        | å¤‡ä»½é—´éš”ï¼Œå•ä½:ç§’ |
| DATASET_N     | 10           | å¤‡ä»½å®¹é‡          |
| BACKUP_DIR    | $HOME/.halo2 | å¤‡ä»½ç›®å½•          |

### å¤‡ä»½åˆ°Huggingface

-   è®¿é—®éš§é“ç»‘å®šçš„åŸŸååˆå§‹åŒ–ç«™ç‚¹å¹¶ç™»å½•åå°

-   ç™»å…¥åç‚¹å‡»å·¦ä¾§ **å¤‡ä»½** èœå• - **æ¢å¤** - **æˆ‘å·²é˜…è¯»ä¸Šæ–¹æç¤ºï¼Œå¼€å§‹æ¢å¤**

-   ç‚¹å‡» **æµè§ˆ** é€‰æ‹©å¤‡ä»½ï¼Œç„¶åç‚¹å‡» **ä¸Šä¼ 1ä¸ªæ–‡ä»¶**ï¼Œå¹¶ç‚¹å‡» **ç¡®å®š**

-   ç­‰å¾…é‡å¯ï¼Œé‡å¯å®Œæˆé¡µé¢ä¼šè‡ªåŠ¨åˆ·æ–°ï¼Œæ¥ç€è¾“å…¥æ­£ç¡®çš„ç”¨æˆ·åå’Œå¯†ç å³å¯ç™»å½•åå°ï¼Œç‚¹å‡» **Halo** å³å¯è®¿é—®åšå®¢é¡µé¢

## å‚è€ƒé“¾æ¥

-   [**ä½¿ç”¨ JAR æ–‡ä»¶éƒ¨ç½²Halo**](https://docs.halo.run/getting-started/install/jar-file)
-   [**åœ¨huggingfaceéƒ¨ç½²haloï¼ˆå®ç°datasetåŒæ­¥**ï¼‰](https://linux.do/t/topic/426007)