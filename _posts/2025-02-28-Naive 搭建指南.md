---
layout: mypost
title: Naive 搭建指南
date: 2025-02-28
published: false
categories: 代理
tags: 
 - naive
---

开始前需要准备以下工作：

1.  开放服务器的80和443端口
    
2.  将域名托管到cloudflare，并添加A记录指向服务器ip
    

**注意**：不要打开小黄云（CDN）

## 服务端

### **安装编译**

```bash
sudo -i
apt install golang-go
go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest
~/go/bin/xcaddy build --with github.com/caddyserver/forwardproxy@caddy2=github.com/klzgrad/forwardproxy@naive
```

### **配置文件**

```bash
cat > Caddyfile <<EOF
:443, example.com # 你的域名
tls example@example.com # 你的邮箱
route {
  forward_proxy {
    basic_auth username1 password1 # 用户名1和密码1
    hide_ip
    hide_via
    probe_resistance
  }
  # 支持多用户
  forward_proxy {
    basic_auth username2 password2 # 用户名2和密码2
    hide_ip
    hide_via
    probe_resistance
  }
  reverse_proxy https://demo.cloudreve.org { # 伪装网址
    header_up Host {upstream_hostport}
    header_up X-Forwarded-Host {host}
  }
}
EOF
```

### **安装证书**

```bash
./caddy run
```

出现`certificate obtained successfully`表示安装证书成功，CTRL+C 退出运行

### **性能优化**

```bash
sudo tee -a /etc/sysctl.conf <<EOF
net.core.default_qdisc=fq
net.ipv4.tcp_congestion_control=bbr
net.ipv4.tcp_notsent_lowat=131072
net.ipv4.tcp_rmem=4096 131072 67108864
net.ipv4.tcp_slow_start_after_idle=0
EOF

sudo sysctl -p
```

### **创建服务**

```bash
sudo bash -c 'cat > /etc/systemd/system/caddy.service << EOF
[Unit]
Description=Caddy
Documentation=https://caddyserver.com/docs/
After=network.target network-online.target
Requires=network-online.target

[Service]
Type=notify
User=root
Group=root
ExecStart=/root/caddy run --environ --config /root/Caddyfile
ExecReload=/root/caddy reload --config /root/Caddyfile --force
TimeoutStopSec=5s
LimitNOFILE=1048576
LimitNPROC=512
PrivateTmp=true
ProtectSystem=full
AmbientCapabilities=CAP_NET_BIND_SERVICE

[Install]
WantedBy=multi-user.target
EOF'

sudo systemctl daemon-reload
sudo systemctl start caddy
sudo systemctl enable caddy
sudo systemctl status caddy
```

## 客户端

### 桌面设备

#### **下载 v2rayN**

-   访问下方仓库的Relaese页面，下载与你的操作系统相对应的压缩包并解压
    
    [https://github.com/2dust/v2rayN](https://github.com/2dust/v2rayN)

#### **导入 naive 内核**

-   访问下方仓库的Relaese页面，下载与你的操作系统相对应的压缩包并解压
    
    [https://github.com/klzgrad/naiveproxy](https://github.com/klzgrad/naiveproxy)
-   将执行文件放入 `v2rayN` 解压后目录的 `bin/naiveproxy` 文件夹中
    

#### **修改配置文件**

-   找到解压得到的 `config.json` 文件，并用文本编辑器打开
    
-   将以下内容复制替换到 `config.json` 中（请根据需要修改）
    
    ```json
    {
      "listen": "socks://127.0.0.1:10808",
      "proxy": "https://用户名:密码@域名"
    }
    ```

-   替换 `用户名`、`密码` 和 `域名` 为实际信息
    

#### **优化连接数**

-   打开注册表编辑器，按 `Win + R`，输入 `regedit`，然后回车，接着导航到以下路径
    
    ```bash
    HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Edge
    ```
    
    如果 `Edge` 目录不存在，你需要手动创建：右键 `Microsoft` → **新建** → **项**，命名为 `Edge`
    
-   在 `Edge` 目录下，右键空白处，选择 **新建** → **DWORD (32 位) 值**，命名为`MaxConnectionsPerProxy` ，双击该值，将 **数值数据** 修改为99（十进制），然后点击 **确定**
    
-   关闭所有 Edge 窗口，然后重新打开，在 Edge 地址栏输入`edge://policy` ，查找 `MaxConnectionsPerProxy`，如果值是 `99`，说明优化成功
    

#### **运行 v2rayN**

-   打开 `v2rayN` 解压后的目录，双击 v2rayN 执行文件运行程序
    
-   点击菜单中的 “服务器” 选项，然后选择 “添加自定义配置服务器”
    
-   在弹出的窗口中：
    
    -   别名输入 `Naive`
        
    -   点击 “浏览” 按钮，选择你刚刚修改过的 `config.json` 文件
        
    -   在 “Core类型” 中选择 `naiveproxy`
        
    -   在 “Socks端口” 中输入 `10808`
    
-   最后，点击 “确定” 完成设置，开启浏览器前置代理或全局代理后开始使用
    

### 移动设备

-   安装 Shadowrocket，打开 Shadowrocket 应用，点击右上角的 **+** 按钮，类型选择 **HTTP2**
    
-   在地址栏中输入你的域名，注意不要加协议前缀（http:// 或 https://），端口填写 443，用户名、密码根据 Caddyfile 的配置填写
    
-   填写完成后，点击右上角的 “保存” 按钮，接下来添加好的配置，点击 **未连接** 右侧的开关切换成 **已连接** 就可以使用了
    

## 参考链接

[**NaiveProxy安装笔记**](https://idev.dev/proxy/naiveproxy.html)

[**自建节点最完美的隐藏方案——naive节点搭建（tls指纹问题）**](https://bulianglin.com/archives/naive.html)

