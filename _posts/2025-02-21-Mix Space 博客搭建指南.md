---
layout: mypost
title: Mix Space åšå®¢æ­å»ºæŒ‡å—
date: 2025-02-21
published: true
categories: åšå®¢
tags: 
 - blog
---

## å…¥é—¨ç¯‡ï¼šDocker éƒ¨ç½²

**æ¨èæŒ‡æ•°**ï¼šâ˜…â˜…â˜…â˜…â˜…

**éš¾åº¦æŒ‡æ•°**ï¼šâ˜…

ä½¿ç”¨ Docker éƒ¨ç½²ï¼Œå‰åç«¯ä¸åšåˆ†ç¦»ï¼Œéƒ¨ç½²è¦æ±‚å¦‚ä¸‹ï¼š

-   1å°æœåŠ¡å™¨ï¼Œè¦æ±‚å†…å­˜ >**1G**
-   1ä¸ªåŸŸåï¼ˆå›½å†…æœåŠ¡å™¨éœ€å¤‡æ¡ˆï¼‰

**æ³¨æ„**ï¼šåç«¯é»˜è®¤ä¸å¸¦ä¸»é¢˜ï¼Œè¿è¡ŒæœåŠ¡åè¿˜éœ€ç™»å…¥åå°ç®¡ç†ç•Œé¢ `https://www.blog.com/proxy/qaqdmin` å‚ç…§ **äº‘å‡½æ•°** é…ç½®ä¸»é¢˜

### é…ç½®æ–‡ä»¶

æ–‡ä»¶ç›®å½•ç»“æ„å¦‚ä¸‹ï¼Œ`.env` å’Œ `docker-compose.yml`éœ€è¦ç”¨æˆ·åˆ›å»ºï¼Œ**data** ç›®å½•åœ¨å®¹å™¨è¿è¡Œåè‡ªåŠ¨ç”Ÿæˆ

    ğŸ“‚ ~/mix-space
    â”‚
    â”œâ”€â”€ ğŸ“œ .env
    â”œâ”€â”€ ğŸ“œ docker-compose.yml
    â””â”€â”€ ğŸ“‚ data
        â”œâ”€â”€ ğŸ“‚ mongo
        â”œâ”€â”€ ğŸ“‚ redis
        â””â”€â”€ ğŸ“‚ core

#### .env

**æ³¨æ„**ï¼šAPI ç›¸å…³é…ç½® ä¸€èˆ¬ä¸éœ€ä¿®æ”¹

```ini
# ğŸ’» å‰ç«¯é…ç½®
# ğŸŒ API ç›¸å…³é…ç½®
NEXT_PUBLIC_API_URL=http://core:2333/api/v2
NEXT_PUBLIC_GATEWAY_URL=http://core:2333/

# ğŸ”‘ è®¤è¯ & API å¯†é’¥
TMDB_API_KEY=
GH_TOKEN=

# ğŸ–¥ï¸ åç«¯é…ç½®
# ğŸ” å®‰å…¨æ€§é…ç½®
JWT_SECRET=G7xJpQzW8mV4L2YfK9N6T1RbX3dMC0H(32ä½)
ALLOWED_ORIGINS=
ENCRYPT_KEY=593f62860255feb0a914534a43814b9809cc7534da7f5485cd2e3d3c8609acab(64ä½)
ENCRYPT_ENABLE=false

# ğŸš€ ç¼“å­˜ç›¸å…³é…ç½®
CDN_CACHE_HEADER=true
FORCE_CACHE_HEADER=false

# ğŸ›¢ æ•°æ®åº“é…ç½®
MONGO_CONNECTION=

# âš¡ è¯·æ±‚é™æµï¼ˆThrottleï¼‰
THROTTLE_TTL=10
THROTTLE_LIMIT=20
```

#### dockers-compose.yml

```yaml
services:
  shiro:
    container_name: shiro
    image: innei/shiro:latest
    volumes:
      - ./.env:/app/.env
    restart: always
    environment:
      - NEXT_SHARP_PATH=/usr/local/lib/node_modules/sharp
    ports:
      - "127.0.0.1:2323:2323"
    depends_on:
      - core
    networks:
      - mix-space

  core:
    container_name: core
    image: innei/mx-server:latest
    environment:
      - TZ=Asia/Shanghai
      - NODE_ENV=production
      - DB_HOST=mongo
      - REDIS_HOST=redis
    volumes:
      - ./data/core:/root/.mx-space
    ports:
      - "127.0.0.1:2333:2333"
    depends_on:
      - mongo
      - redis
    networks:
      - mix-space
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:2333/api/v2/ping"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 30s

  mongo:
    container_name: mongo
    image: mongo
    volumes:
      - ./data/mongo:/data/db
    networks:
      - mix-space
    restart: unless-stopped

  redis:
    image: redis:alpine
    container_name: redis
    volumes:
      - ./data/redis:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
      start_period: 20s
      interval: 30s
      retries: 5
      timeout: 3s
    networks:
      - mix-space
    restart: unless-stopped

networks:
  mix-space:
    driver: bridge
```

### nginxåä»£

è¯·åœ¨åŸŸåï¼ˆä»¥`www.blog.com`ä¸ºä¾‹ï¼‰æ·»åŠ ä¸€æ¡ Aè®°å½•æŒ‡å‘æœåŠ¡å™¨ IPï¼Œç„¶åæ·»åŠ ä»¥ä¸‹ server å—

```nginx
server {
    listen 80;
    listen 443 ssl http2 ; 
   
    server_name www.blog.com; 
    index index.html; 
    proxy_set_header Host $host; 
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
    proxy_set_header X-Forwarded-Host $server_name; 
    proxy_set_header Upgrade $http_upgrade; 
    proxy_set_header Connection "upgrade"; 
    error_log /www/sites/www.example.com/log/error.log;
    access_log /www/sites/www.example.com/log/access.log; 
    location /socket.io {
        proxy_set_header Upgrade $http_upgrade; 
        proxy_set_header Connection "Upgrade"; 
        proxy_set_header Host $host; 
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
        proxy_set_header X-Forwarded-Proto $scheme; 
        proxy_pass http://127.0.0.1:2333/socket.io; 
    }
    location /api/v2 {
        proxy_pass http://127.0.0.1:2333/api/v2; 
    }
    location /render {
        proxy_pass http://127.0.0.1:2333/render; 
    }
    location / {
        proxy_pass http://127.0.0.1:2323; 
    }
    location /qaqdmin {
        proxy_pass http://127.0.0.1:2333/proxy/qaqdmin;
    }
    location /proxy {
        proxy_pass http://127.0.0.1:2333/proxy;
    }
 
    location ~* \/(feed|sitemap|atom.xml) {
        proxy_pass http://127.0.0.1:2333/$1; 
    }
    ssl_certificate /www/sites/www.example.com/ssl/fullchain.pem; 
    ssl_certificate_key /www/sites/www.example.com/ssl/privkey.pem; 
    ssl_protocols TLSv1.3 TLSv1.2 TLSv1.1 TLSv1; 
    ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK'; 
    ssl_prefer_server_ciphers on; 
    ssl_session_cache shared:SSL:10m; 
    ssl_session_timeout 10m; 
    error_page 497 https://$host$request_uri; 
    limit_conn perserver 300; 
    limit_conn perip 25; 
    limit_rate 512k; 
}
```

## è¿›é˜¶ç¯‡ï¼šä¼ ç»Ÿæ–¹æ³•éƒ¨ç½²

**æ¨èæŒ‡æ•°**ï¼šâ˜…â˜…â˜…

**éš¾åº¦æŒ‡æ•°**ï¼šâ˜…â˜…â˜…

æ„å»ºéƒ¨ç½²ï¼Œå‰åç«¯åˆ†ç¦»ï¼Œéƒ¨ç½²è¦æ±‚å¦‚ä¸‹ï¼š

-   **ç®€å•éƒ¨ç½²/è‡ªåŠ¨éƒ¨ç½²**ï¼š
    -   1å°æœåŠ¡å™¨ï¼Œè¦æ±‚å†…å­˜>**1G**
        
    -   2ä¸ªåŸŸåï¼Œå¯ä»¥æ˜¯å­åŸŸå
-   **æ‰‹åŠ¨éƒ¨ç½²**
    
    -   1å°æœåŠ¡å™¨ï¼Œè¦æ±‚å†…å­˜>**2G**
    -   2ä¸ªåŸŸåï¼Œå¯ä»¥æ˜¯å­åŸŸå

**æ³¨æ„**ï¼šåç«¯é»˜è®¤ä¸å¸¦ä¸»é¢˜ï¼Œè¿è¡ŒæœåŠ¡åè¿˜éœ€ç™»å…¥åå°ç®¡ç†ç•Œé¢ `https://backend.blog.com/proxy/qaqdmin` å‚ç…§ **äº‘å‡½æ•°** é…ç½®ä¸»é¢˜

### æ„å»ºåç«¯

#### å‡†å¤‡ç¯å¢ƒ

-   å®‰è£… nodejsï¼Œå»ºè®®å®‰è£… 20.12.2 ç‰ˆæœ¬
    
    ```bash
    sudo apt-get install curl
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
    nvm install 20.12.2
    ```
    
-   å®‰è£… redis
    
    ```bash
    sudo apt-get install redis-server
    ```
    
-   å®‰è£… mongodbï¼Œè¿™é‡Œä»¥ **Ubuntu 24.04** ä¸ºä¾‹
    
    ```bash
    sudo apt-get install gnupg
    
    curl -fsSL https://www.mongodb.org/static/pgp/server-8.0.asc | \
       sudo gpg -o /usr/share/keyrings/mongodb-server-8.0.gpg \
       --dearmor
    echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu noble/mongodb-org/8.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-8.0.list
    
    sudo apt-get update
    sudo apt-get install -y mongodb-org
    sudo systemctl start mongod
    sudo systemctl enable mongod
    sudo systemctl status mongod
    ```
    
    å…¶ä½™ç³»ç»Ÿå®‰è£…å¯å‚è€ƒï¼š[MongoDB å®˜æ–¹æ–‡æ¡£](https://www.mongodb.com/zh-cn/docs/manual/installation/)
    

#### ç®€å•éƒ¨ç½²

åç«¯ä»“åº“ï¼š[Mix Space/core](https://github.com/mx-space/core)

-   ç›´æ¥ä¸‹è½½æ„å»ºå¥½çš„ linux ç‰ˆ
    
    ```bash
    mkdir ~/mix-space/core && cd $_
    curl -L -O https://github.com/mx-space/core/releases/latest/download/release-linux.zip
    unzip release-linux.zip
    rm release-linux.zip
    ```
    
-   ç”Ÿæˆ32ä½å’Œ64ä½å­—ç¬¦
    
    ```bash
    openssl rand -base64 24 | cut -c1-32 # ç”¨äºjwt_secret
    openssl rand -base64 48 | cut -c1-64 # ç”¨äºencrypt key
    ```
    
-   ç¼–è¾‘`ecosystem.config.js`
    
    ```js
    const { cpus } = require('os');
    const { execSync } = require('child_process');
    const nodePath = execSync(`npm root --quiet -g`, { encoding: 'utf-8' }).trim();
    const cpuLen = cpus().length;
    
    module.exports = {
      apps: [
        {
          name: 'mix-space',
          script: 'index.js',
          autorestart: true,
          exec_mode: 'cluster',
          watch: false,
          instances: cpuLen,
          max_memory_restart: '500M',
          args: [
            '--color',
            '--encrypt_enable',
            '--encrypt_key ********************************(64ä½)',
            '--port 2333',
            '--allowed_origins example1.com,example2.com,localhost',
            '--jwt_secret ********************(16~32ä½)',
          ].join(' '),
          env: {
            NODE_ENV: 'production',
            NODE_PATH: nodePath,
          },
        },
      ],
    };
    ```
    
-   å¯åŠ¨åç«¯æœåŠ¡
    
    ```bash
    npm install -g pm2
    pm2 start ecosystem.config.js
    ```

#### æ‰‹åŠ¨éƒ¨ç½²

-   å®‰è£…åç«¯æœåŠ¡
    
    ```bash
    mkdir ~/mix-space && cd $_
    git clone https://github.com/mx-space/core.git --depth=1
    cd core
    npm install -g pnpm
    pnpm i
    ```
    
-   æ„å»ºåç«¯æœåŠ¡
    
    ```bash
    pnpm build
    pnpm bundle
    ```
    
-   åˆ›å»ºç¬¦å·é“¾æ¥ï¼Œå¹¶å‚ç…§ **ç®€å•éƒ¨ç½²** ä¿®æ”¹ `ecosystem.config.js`
    
    ```bash
    ln -s ./app/core/ecosystem.config.js ecosystem.config.js
    ```
    
-   å¯åŠ¨åç«¯æœåŠ¡
    
    ```bash
    npm install -g pm2
    pm2 start ecosystem.config.js
    ```
    

### æ„å»ºå‰ç«¯

#### å‡†å¤‡ç¯å¢ƒ

-   å®‰è£…ä¾èµ–
    
    ```bash
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
    nvm install 20.12.2
    npm install -g pnpm pm2 
    npm i -g sharp
    ```
    

#### ç®€å•éƒ¨ç½²

-   å‰ç«¯ä»“åº“ï¼š[Innie/Shiro](https://github.com/Innei/Shiro)
    
-   ç›´æ¥ä¸‹è½½æ„å»ºå¥½çš„ linux ç‰ˆ
    
    ```bash
    mkdir ~/mix-space/shiro && cd $_
    curl -L -O https://github.com/Innei/Shiro/releases/latest/download/release.zip
    unzip release.zip
    rm release.zip
    ```
    
-   ç¼–è¾‘`ecosystem.config.js`
    
    ```js
    module.exports = {
      apps: [
        {
          name: 'shiro',
          script: 'server.js',
          autorestart: true,
          watch: false,
          max_memory_restart: '500M',
          env: {
            PORT: 2323,
            NODE_ENV: 'production',
            NEXT_SHARP_PATH: process.env.NEXT_SHARP_PATH,
    	    NEXT_PUBLIC_API_URL: 'http://127.0.0.1:2323/api/v2',
    	    NEXT_PUBLIC_GATEWAY_URL: 'http://127.0.0.1:2323'
          },
          log_date_format: 'YYYY-MM-DD HH:mm:ss',
        },
      ],
    }
    ```
    
-   å¯åŠ¨å‰ç«¯æœåŠ¡
    
    ```bash
    pm2 start ecosystem.config.js
    ```
    

#### è‡ªåŠ¨éƒ¨ç½²

-   åˆ›å»ºå‰ç«¯ç›®å½•
    
    ```bash
    mkdir -p ~/mix-space/shiro && cd $_
    ```
    
    ç¼–è¾‘ç¯å¢ƒå˜é‡`.env`
    
    ```ini
    NEXT_PUBLIC_API_URL=https://example.net/api/v2
    NEXT_PUBLIC_GATEWAY_URL=https://example.net
    TMDB_API_KEY=
    GH_TOKEN=
    ```
    
-   Fork å‰ç«¯ä»“åº“ï¼Œç­‰å¾…å®Œæˆåè¿›å…¥ **Actions** æ ‡ç­¾å¯ç”¨ Workflowï¼Œæ¥ç€è¿›å…¥ **Settings** æ ‡ç­¾ï¼Œå·¦ä¾§ç‚¹å‡» \[**Secrets and variables\]** \- \[**Actions\] - \[New repository secret\]** æ·»åŠ ä»¥ä¸‹å˜é‡
    

| **Name** | **Secret**                         | **Description**              |
| :------- | :--------------------------------- | :--------------------------- |
| HOST     | [example.com](http://example.com/) | SSH ç™»å½•åœ°å€                 |
| PORT     | 22                                 | SSH ç™»å½•ç«¯å£                 |
| USER     | admin                              | SSH ç™»å½•ç”¨æˆ·å               |
| PASSWORD | P@ssw0rd                           | SSH ç™»å½•å¯†ç ï¼Œä¸ KEY äºŒé€‰ä¸€  |
| KEY      | ssh-rsa*****                       | SSH ç§é’¥ï¼Œä¸ PASSWORD äºŒé€‰ä¸€ |

-   åˆ‡æ¢åˆ° **Code** æ ‡ç­¾ï¼Œæ–°å»º`.github/workflows/deploy.yml`
    
    ```yaml
    name: Deploy
    
    on:
      push:
        branches: [main]
    
    permissions:
      contents: write
    
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    
    jobs:
      build:
        name: Build artifact
        runs-on: ubuntu-latest
        strategy:
          matrix:
            node-version: [20.x]
        steps:
          - uses: actions/checkout@v4
            with:
              fetch-depth: 0
              lfs: true
    
          - name: Checkout LFS
            run: git lfs checkout
    
          - uses: pnpm/action-setup@v2
            with:
              version: 9.x.x
    
          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: ${{ matrix.node-version }}
              cache: 'pnpm'
    
          - uses: jongwooo/next-cache@v1
    
          - name: Install & Build
            run: |
              pnpm install
              sh ./ci-release-build.sh
    
          - uses: actions/upload-artifact@v4
            with:
              name: release.zip
              path: assets/release.zip
    
      deploy:
        name: Deploy artifact
        runs-on: ubuntu-latest
        needs: build
        steps:
          - uses: actions/download-artifact@v4
            with:
              name: release.zip
    
          - name: SCP Transfer
            uses: appleboy/scp-action@v0.1.7
            with:
              host: ${{ secrets.HOST }}
              username: ${{ secrets.USER }}
              key: ${{ secrets.KEY }}
              password: ${{ secrets.PASSWORD }}
              port: ${{ secrets.PORT }}
              source: release.zip
              target: /tmp/shiro
    
          - name: Remote Deployment
            uses: appleboy/ssh-action@v0.1.7
            with:
              host: ${{ secrets.HOST }}
              username: ${{ secrets.USER }}
              key: ${{ secrets.KEY }}
              password: ${{ secrets.PASSWORD }}
              port: ${{ secrets.PORT }}
              script: |
                set -ex
                source $HOME/.bashrc
                basedir=$HOME/mix-space/shiro
                workdir=$basedir/${{ github.sha }}
                mkdir -p $workdir
                mkdir -p $basedir/.cache
                mv /tmp/shiro/release.zip $workdir/release.zip
                rm -r /tmp/shiro
                cd $workdir
                unzip -qq -o $workdir/release.zip
                rm -rf $workdir/standalone/.env
                ln -s $HOME/shiro/.env $workdir/standalone/.env
                export NEXT_SHARP_PATH=$(npm root -g)/sharp
                # copy workdir ecosystem.config.js to basedir if not exists
                if [ ! -f $basedir/ecosystem.config.js ]; then
                  cp $workdir/standalone/ecosystem.config.js $basedir/ecosystem.config.js
                fi
                # https://github.com/Unitech/pm2/issues/3054
                # symlink workdir node entry file to basedir
                ln -sf $workdir/standalone/server.js $basedir/server.js
                mkdir -p $workdir/standalone/.next
                rm -rf $workdir/standalone/.next/cache
                ln -sf $basedir/.cache $workdir/standalone/.next/cache
                cd $basedir
                pm2 reload ecosystem.config.js --update-env
                rm $workdir/release.zip
                pm2 save
                echo "Deployed successfully"
    ```
    
-   ç‚¹å‡» **Sync fork** å¯ä»¥åŒæ­¥å®˜æ–¹ä»“åº“çš„æ›´æ–°ï¼ŒåŒæ­¥åä¼šè§¦å‘è‡ªåŠ¨éƒ¨ç½²
    
-   å¦å¤–ï¼Œä¹Ÿå¯ [ç‚¹å‡»åˆ›å»º](https://vercel.com/new/clone?repository-url=https://github.com/Innei/Shiro&env=NEXT_PUBLIC_API_URL,NEXT_PUBLIC_GATEWAY_URL&envDescription=Mix-Spaceåç«¯çš„é…ç½®) ä¸€é”®éƒ¨ç½²åˆ°vercelï¼Œæ³¨æ„æ·»åŠ ç¯å¢ƒå˜é‡ï¼ŒåŒæ­¥ä»“åº“ä¹Ÿä¼šè‡ªåŠ¨æ›´æ–°
    

### é…ç½® nginx

-   å‰ç«¯é…ç½®
    
    ```nginx
    location ~* \.(gif|png|jpg|css|js|woff|woff2|svg|webp)$ {
      proxy_pass http://127.0.0.1:2323;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header REMOTE-HOST $remote_addr;
      expires 30d;
    }
    location ~* \/(feed|sitemap|atom.xml) {
      proxy_pass http://127.0.0.1:2333/$1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header REMOTE-HOST $remote_addr;
      add_header X-Cache $upstream_cache_status;
      add_header Cache-Control max-age=60;
    }
    location / {
      proxy_pass http://127.0.0.1:2323;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header REMOTE-HOST $remote_addr;
      add_header X-Cache $upstream_cache_status;
      add_header Cache-Control no-cache;
      proxy_intercept_errors on;
    }
    ```
    
-   åç«¯é…ç½®
    
    ```nginx
    location /socket.io {
      proxy_pass http://127.0.0.1:2333/socket.io; 
      proxy_set_header Host $host; 
      proxy_set_header X-Real-IP $remote_addr; 
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header REMOTE-HOST $remote_addr; 
      proxy_set_header Upgrade $http_upgrade; 
      proxy_set_header Connection "upgrade"; 
      proxy_buffering off;
      proxy_http_version 1.1; 
      add_header Cache-Control no-cache; 
    }
    
    location / {
      proxy_pass http://127.0.0.1:2333; 
      proxy_set_header Host $host; 
      proxy_set_header X-Real-IP $remote_addr; 
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header REMOTE-HOST $remote_addr; 
      add_header X-Cache $upstream_cache_status; 
    }    
    ```

## ç‰¹åˆ«ç¯‡ä¸€ï¼šrender éƒ¨ç½²

**æ¨èæŒ‡æ•°**ï¼šâ˜…â˜…â˜…â˜…

**éš¾åº¦æŒ‡æ•°**ï¼šâ˜…â˜…â˜…â˜…

### å‡†å¤‡å·¥ä½œ

1. æ³¨å†Œ mongoDB
2. æ³¨å†Œ github
3. æ³¨å†Œ render
4. æ³¨å†Œ vercel

### æ­å»ºæ¡†æ¶

- MongoDB æ•°æ®åº“
- Render éƒ¨ç½² Redis ç¼“å­˜
- Vercel æ‰˜ç®¡çš„å‰ç«¯ä¸»é¢˜ Shiro
- Render éƒ¨ç½²åç«¯ Mix Space

```
ğŸ“¦ é¡¹ç›®ç»“æ„
â”œâ”€â”€ ğŸ—„ï¸ æ•°æ®åº“ (MongoDB)
â”‚   â”œâ”€â”€ ğŸ“‚ ç”¨æˆ·æ•°æ®
â”‚   â”œâ”€â”€ ğŸ“‚ æ–‡ç« æ•°æ®
â”‚   â”œâ”€â”€ ğŸ“‚ å…¶ä»–ä¸šåŠ¡æ•°æ®
â”‚
â”œâ”€â”€ ğŸ”¥ ç¼“å­˜å±‚ (Redis - Render éƒ¨ç½²)
â”‚   â”œâ”€â”€ âš¡ å­˜å‚¨ä¼šè¯ä¿¡æ¯
â”‚   â”œâ”€â”€ âš¡ å­˜å‚¨çƒ­ç‚¹æ•°æ®
â”‚   â”œâ”€â”€ âš¡ é™ä½æ•°æ®åº“æŸ¥è¯¢å‹åŠ›
â”‚
â”œâ”€â”€ ğŸ¨ å‰ç«¯ (Shiro ä¸»é¢˜ - Vercel æ‰˜ç®¡)
â”‚   â”œâ”€â”€ ğŸ“¦ ä¾èµ–: Next.js / React
â”‚   â”œâ”€â”€ ğŸ¨ UI ç»„ä»¶
â”‚   â”œâ”€â”€ ğŸ”— è°ƒç”¨åç«¯ API
â”‚   â”œâ”€â”€ âš™ï¸ çŠ¶æ€ç®¡ç†
â”‚
â”œâ”€â”€ ğŸš€ åç«¯ (Mix Space - Render éƒ¨ç½²)
â”‚   â”œâ”€â”€ ğŸ“¦ ä¾èµ–: Nest.js
â”‚   â”œâ”€â”€ ğŸ”— è¿æ¥ MongoDB
â”‚   â”œâ”€â”€ ğŸ”— è¿æ¥ Redis ç¼“å­˜
â”‚   â”œâ”€â”€ ğŸ”’ è®¤è¯ & æˆæƒ
â”‚   â”œâ”€â”€ ğŸ“¡ API å¤„ç†
â”‚
â””â”€â”€ ğŸŒ éƒ¨ç½²
    â”œâ”€â”€ ğŸ“¤ å‰ç«¯éƒ¨ç½²åˆ° Vercel
    â”œâ”€â”€ ğŸ“¤ åç«¯ & Redis éƒ¨ç½²åˆ° Render
    â”œâ”€â”€ ğŸ› ï¸ CI/CD è‡ªåŠ¨åŒ–
```

**æ³¨æ„**ï¼šåç«¯é»˜è®¤ä¸å¸¦ä¸»é¢˜ï¼Œè¿è¡ŒæœåŠ¡åè¿˜éœ€ç™»å…¥åå°ç®¡ç†ç•Œé¢ `https://www.blog.com/proxy/qaqdmin` å‚ç…§æ•™ç¨‹æœ€å  **äº‘å‡½æ•°** é…ç½®ä¸»é¢˜

### å¼€å§‹æ­å»º

1. **æ•°æ®åº“ï¼šMongoDB**

   åˆ›å»ºæ­¥éª¤å‚è€ƒ [æŠ±è„¸éƒ¨ç½²LibreChatæ•™ç¨‹ ](https://linux.do/t/topic/96509#p-657221-mongodb-5)ï¼Œ è¿™é‡Œä¸å†èµ˜è¿°

2. **ç¼“å­˜ï¼šRedis**

   - ç™»é™† renderï¼Œä¾æ¬¡ç‚¹å‡»å³ä¸Šè§’  **+**  â†’  **Key Value**
   - **Name** å¡«å†™ **redis**
   - **Project** é€‰æ‹© **Production**
   - **Region** é€‰æ‹© **Singapore**
   - **Instance Type** é€‰æ‹© **Free**
   - ç‚¹å‡» **Create Key Value Instance** åˆ›å»º
   - ä¸‹æ‹‰åœ¨ **Connections** ä¸‹å¤åˆ¶ **Internal Key Value URL**ï¼Œå½¢å¦‚ `redis://red-cvdd4eofnakc738i3f00:6379`ï¼Œç²˜è´´åˆ°å‰ªè´´æ¿ååªä¿ç•™ä¸­é—´éƒ¨åˆ†`red-cvdd4eofnakc738i3f00` ä½œä¸º `REDIS_HOST`

3. **å‰ç«¯ï¼šShiro**

   - [ç‚¹å‡»åˆ›å»º](https://vercel.com/new/clone?repository-url=https://github.com/Innei/Shiro&env=NEXT_PUBLIC_API_URL,NEXT_PUBLIC_GATEWAY_URL&envDescription=Mix-Spaceåç«¯çš„é…ç½®)ï¼Œåç§°å¡«å†™ `shiro`ï¼Œä¿®æ”¹ç¯å¢ƒå˜é‡åç‚¹å‡» **Deploy** éƒ¨ç½²

     | Name                    | Value                             | Description     |
     | ----------------------- | --------------------------------- | --------------- |
     | NEXT_PUBLIC_API_URL     | `https://backend.blog.com/api/v2` | åç«¯APIæ¥å£åœ°å€ |
     | NEXT_PUBLIC_GATEWAY_URL | `https://backend.blog.com/`       | åç«¯åŸŸå        |

   - ä¿®æ”¹åŒºåŸŸï¼Œåœ¨ **Settings** - **Functions** - **Function Region** é€‰æ‹© **Asia** - **Hong Kong**ï¼Œæ³¨æ„å…ˆå–æ¶ˆå‹¾é€‰å†é€‰æ‹©

   - è‡ªå®šä¹‰åŸŸï¼Œæ³¨æ„ vercel åˆ†é…çš„åŸŸåå›½å†…æ— æ³•ç›´è¿éœ€è¦æ·»åŠ è‡ªå®šä¹‰åŸŸï¼š

     1. åœ¨ cloudflare éœ€è¦ç»‘å®šçš„åŸŸåæ·»åŠ ä¸€æ¡ A è®°å½•æŒ‡å‘ `76.223.126.88` 
     2. è¿›å…¥ vercel çš„ shiro é¡¹ç›®ä¾æ¬¡ç‚¹å‡» **Settings** - **Domains** - **Add** 
     3. è¾“å…¥ç»‘å®šçš„åŸŸåï¼Œç„¶åç‚¹å‡» **Add Domain**ï¼Œæ³¨æ„å‹¾é€‰ç¬¬ä¸‰é¡¹åç‚¹å‡» **Add** å®ŒæˆåŸŸåè‡ªå®šä¹‰

     è¿™é‡Œå‡å®šæ·»åŠ çš„è‡ªå®šä¹‰åŸŸä¸º `frontend.blog.com`

4. **åç«¯ï¼šMix Space**

   - ç™»å½• renderï¼Œä¾æ¬¡ç‚¹å‡»å³ä¸Šè§’  **+**  â†’  **Web Service**

   - é€‰æ‹© **Existing image**ï¼Œ**Image URL** è¾“å…¥ `innei/mx-server:latest`

   - ç¨ç­‰å‡ ç§’ï¼Œç‚¹å‡» **Connect**

   - **Name** ä¿®æ”¹ä¸º **core**

   - **Project** é€‰æ‹© **Production**

   - **Region** é€‰æ‹© **Singapore**

   - **Instance Type** é€‰æ‹© **Free**

   - **Environment Variables** ä¸‹æ–¹ç‚¹å‡» **Add from .env**ï¼Œä¿®æ”¹ä»¥ä¸‹ç¯å¢ƒå˜é‡åç²˜è´´åˆ°è¾“å…¥æ¡†

     ```ini
     ALLOWED_ORIGINS=frontend.blog.com
     REDIS_HOST=red-cvdd4eofnakc738i3f00
     DB_CONNECTION_STRING=mongodb+srv://<DB_USER>:<DB_PASSWORD>@<DB_USER>
     JWT_SECRET=************************
     ```

     å…¶ä¸­`JWT_SECRET`å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¿«é€Ÿç”Ÿæˆ

     ```bash
     openssl rand -base64 24 | cut -c1-32
     ```

   - ç‚¹å‡» **Deploy Web Service** éƒ¨ç½²

   - ä¸‹æ»‘åœ¨ **Custom Domains** ä¸‹æ–¹ç‚¹å‡» **+ Add Custom Domain**ï¼Œè¾“å…¥è‡ªå®šä¹‰åŸŸï¼Œæ ¼å¼å¦‚ `backend.blog.com`

   - æŒ‰æç¤ºå‰å¾€åŸŸåæ‰˜ç®¡å¤„ï¼Œå¦‚ cloudflareï¼Œæ·»åŠ ä¸€æ¡ **CNAME** è®°å½•åè¿”å›ç‚¹å‡» **verify** éªŒè¯

## ç‰¹åˆ«ç¯‡äºŒï¼šserv00 éƒ¨ç½²

**æ¨èæŒ‡æ•°**ï¼šâ˜…â˜…â˜…

**éš¾åº¦æŒ‡æ•°**ï¼šâ˜…â˜…â˜…â˜…â˜…

æˆ‘çš„ç”µé“ºç°å·²ä¸Šæ¶ä¸€é”®å®‰è£…è„šæœ¬ï¼Œç®€åŒ–äº†å®‰è£…è¿‡ç¨‹ï¼Œèƒ½å¤Ÿæ›´å¿«é€Ÿåœ°å®Œæˆå®‰è£…ï¼Œæ¬¢è¿å‘ç”µæ”¯æŒ
https://afdian.com/a/ireno?tab=shop

**æ³¨æ„**ï¼šåç«¯é»˜è®¤ä¸å¸¦ä¸»é¢˜ï¼Œè¿è¡ŒæœåŠ¡åè¿˜éœ€ç™»å…¥åå°ç®¡ç†ç•Œé¢ `https://åç«¯åŸŸå/proxy/qaqdmin` å‚ç…§æ•™ç¨‹æœ€å  **äº‘å‡½æ•°** é…ç½®ä¸»é¢˜

```bash
alias node=node20
alias npm=npm20

mkdir -p ~/.npm-global && npm config set prefix "$HOME/.npm-global" && echo 'export PATH=$HOME/.npm-global/bin:$PATH' >> ~/.profile && source ~/.profile && npm install -g pm2 && pm2

mkdir ~/.mx-space
npm install sharp@0.32.5 --prefix ~/.mx-space

devil mongo db add core

devil port add tcp 2323
devil port add tcp 2333
devil port add tcp 5555
cd ~/domains/***.serv00.net

fetch https://raw.githubusercontent.com/redis/redis/7.4/redis.conf

sed -i '' "s/^port .*/port 5555/" redis.conf
sed -i '' -E "s/^# requirepass .*/requirepass secure_pass/" redis.conf
sed -i '' 's/^appendonly no$/appendonly yes/' redis.conf

mkdir -p ~/domains/***.serv00.net/mix-space/core && cd $_
curl -L -O https://github.com/mx-space/core/releases/latest/download/release-linux.zip
unzip release-linux.zip
rm release-linux.zip

mkdir -p ~/domains/***.serv00.net/mix-space/shiro && cd $_
curl -L -O https://github.com/Innei/Shiro/releases/latest/download/release.zip
unzip release.zip
rm release.zip

cat > ~/domains/***.serv00.net/ecosystem.config.js <<EOF
const { execSync } = require('node:child_process');
const nodePath = execSync(`npm root --quiet -g`, { encoding: 'utf-8' }).trim();
module.exports = {
  apps: [
    {
      name: 'shiro',
      script: 'server.js',
      autorestart: true,
      watch: false,
      max_memory_restart: '500M',
      env: {
        PORT: 2323,
        NODE_ENV: 'production',
        NEXT_SHARP_PATH: process.env.NEXT_SHARP_PATH,
	    NEXT_PUBLIC_API_URL: 'http://127.0.0.1:2323/api/v2',
	    NEXT_PUBLIC_GATEWAY_URL: 'http://127.0.0.1:2323'
      },
      log_date_format: 'YYYY-MM-DD HH:mm:ss',
    },  
    {
      name: 'redis',
      script: 'redis-server',
      args: '~/domains/***.serv00.net/mix-space/core/redis.conf',
      autorestart: true,
      watch: false,
    },  
    {
      name: 'core',
      script: 'index.js',
      autorestart: true,
      watch: false,
      max_memory_restart: '500M',
      args: [
        '--color',
        '--encrypt_enable',
        '--encrypt_key ********************(64ä½)',
        '--redis_host 127.0.0.1',
        '--redis_port 5555',
        '--redis_password ********',
        '--db_host mongo15.serv00.com',
        '--collection_name mix-space',
        '--db_user mix-space',
        '--db_password ********',
        '--port 2333',
        '--allowed_origins example1.com,example2.com,localhost',
        '--jwt_secret *************(32ä½)',
      ].join(' '),
      env: {
        NODE_ENV: 'production',
        NODE_PATH: nodePath,
      },
    },
  ],
};
EOF

pm2 start ~/domains/***.serv00.net/ecosystem.config.js
```

## äº‘å‡½æ•°

### Shiro ä¸»é¢˜

-   ç™»å…¥åå°ç‚¹å‡»å·¦ä¾§åº•éƒ¨ **é™„åŠ åŠŸèƒ½** \- **é…ç½®ä¸äº‘å‡½æ•°**ï¼Œç‚¹å‡» **+ æ–°å»º**

-   **åç§°** å¡«å†™ `shiro` ï¼Œ**å¼•ç”¨** å¡«å†™ `theme` ï¼Œå¹¶åœ¨å³ä¾§ä»£ç åŒºç²˜è´´ä»¥ä¸‹ä»£ç ï¼Œè¯·è‡ªè¡Œé…Œæƒ…ä¿®æ”¹

    ````yaml
    {
      "footer": {
        "otherInfo": {
          "date": "2020-{{now}}",
          "icp": {
            "text": "èŒ ICP å¤‡ 20236136 å·",
            "link": "https://icp.gov.moe/?keyword=20236136"
          }
        },
        "linkSections": [
          {
            "name": "å…³äº",
            "links": [
              {
                "name": "å…³äºæœ¬ç«™",
                "href": "/about-site"
              },
              {
                "name": "å…³äºæˆ‘",
                "href": "/about"
              },
              {
                "name": "å…³äºæ­¤é¡¹ç›®",
                "href": "https://github.com/innei/Shiro",
                "external": true
              }
            ]
          },
          {
            "name": "æ›´å¤š",
            "links": [
              {
                "name": "æ—¶é—´çº¿",
                "href": "/timeline"
              },
              {
                "name": "å‹é“¾",
                "href": "/friends"
              },
              {
                "name": "ç›‘æ§",
                "href": "https://status.innei.in/status/main",
                "external": true
              }
            ]
          },
          {
            "name": "è”ç³»",
            "links": [
              {
                "name": "å†™ç•™è¨€",
                "href": "/message"
              },
              {
                "name": "å‘é‚®ä»¶",
                "href": "mailto:i@innei.ren",
                "external": true
              },
              {
                "name": "GitHub",
                "href": "https://github.com/innei",
                "external": true
              }
            ]
          }
        ]
      },
      "config": {
        "color": {
          "light": [
            "#33A6B8",
            "#FF6666",
            "#26A69A",
            "#fb7287",
            "#69a6cc",
            "#F11A7B",
            "#78C1F3",
            "#FF6666",
            "#7ACDF6"
          ],
          "dark": [
            "#F596AA",
            "#A0A7D4",
            "#ff7b7b",
            "#99D8CF",
            "#838BC6",
            "#FFE5AD",
            "#9BE8D8",
            "#A1CCD1",
            "#EAAEBA"
          ]
        },
     
        "bg": [
          "https://github.com/Innei/static/blob/master/images/F0q8mwwaIAEtird.jpeg?raw=true",
          "https://github.com/Innei/static/blob/master/images/IMG_2111.jpeg.webp.jpg?raw=true"
        ],
        "custom": {
          "css": [],
          "styles": [],
          "js": [],
          "scripts": []
        },
        "site": {
          "favicon": "/innei.svg",
          "faviconDark": "/innei-dark.svg"
        },
        "hero": {
          "title": {
            "template": [
              {
                "type": "h1",
                "text": "Hi, I'm ",
                "class": "font-light text-4xl"
              },
              {
                "type": "h1",
                "text": "Innei",
                "class": "font-medium mx-2 text-4xl"
              },
              {
                "type": "h1",
                "text": "ğŸ‘‹ã€‚",
                "class": "font-light text-4xl"
              },
              {
                "type": "br"
              },
              {
                "type": "h1",
                "text": "A NodeJS Full Stack ",
                "class": "font-light text-4xl"
              },
              {
                "type": "code",
                "text": "<Developer />",
                "class": "font-medium mx-2 text-3xl rounded p-1 bg-gray-200 dark:bg-gray-800/0 hover:dark:bg-gray-800/100 bg-opacity-0 hover:bg-opacity-100 transition-background duration-200"
              },
              {
                "type": "span",
                "class": "inline-block w-[1px] h-8 -bottom-2 relative bg-gray-800/80 dark:bg-gray-200/80 opacity-0 group-hover:opacity-100 transition-opacity duration-200 group-hover:animation-blink"
              }
            ]
          },
          "description": "An independent developer coding with love."
        },
        "module": {
          "activity": {
            "enable": true,
            "endpoint": "/fn/ps/update"
          },
          "donate": {
            "enable": true,
            "link": "https://afdian.net/@Innei",
            "qrcode": [
              "https://cdn.jsdelivr.net/gh/Innei/img-bed@master/20191211132347.png",
              "https://cdn.innei.ren/bed/2023/0424213144.png"
            ]
          },
          "bilibili": {
            "liveId": 1434499
          }
        }
      }
    }
    ````

### PS çŠ¶æ€æ’ä»¶

- ç™»å…¥åå°ç‚¹å‡»å·¦ä¾§åº•éƒ¨ **é™„åŠ åŠŸèƒ½** \- **é…ç½®ä¸äº‘å‡½æ•°**ï¼Œç‚¹å‡» **+ æ–°å»º**
- **åç§°** å¡«å†™ `update`ï¼Œ**å¼•ç”¨** å¡«å†™ `ps`ï¼Œ**æ•°æ®ç±»å‹** é€‰æ‹© `Function`ï¼Œ**è¯·æ±‚æ–¹å¼** é€‰æ‹© `POST`ï¼Œ **Secret** å·¦ä¾§è¾“å…¥æ¡†å¡«å…¥ `key`ï¼Œå³ä¾§å¡«å…¥keyçš„å€¼ï¼Œç„¶å [ç‚¹å‡»å‰å¾€](https://raw.githubusercontent.com/mx-space/snippets/refs/heads/main/shiro/functions/ps.ts) å…¨é€‰å¤åˆ¶æ‰€æœ‰å†…å®¹ç²˜è´´åˆ°å³ä¾§ä»£ç åŒºï¼Œæœ€åç‚¹å‡»ç»¿è‰²æŒ‰é’®ä¿å­˜
- ä¸‹è½½å®‰è£… [Kizuna](https://github.com/AlienFamilyHub/Kizuna)ï¼ŒWindows ç³»ç»Ÿå¿«æ·é”®  `WIN + R` è¾“å…¥  `notepad %USERPROFILE%\AppData\Local\kizuna\config.yml` ç¼–è¾‘

```yaml
server_config:
  endpoint: "https://backend.example.com/api/v2/fn/ps/update" # https://api.example.com/api/v2/fn/ps/update
  token: "YOUR-KEY-HERE" # è®¾ç½®çš„key
  report_time: 5 # ä¸ŠæŠ¥æ—¶é—´é—´éš”ï¼Œå•ä½ç§’
rules: # è½¯ä»¶åçš„æ›¿æ¢è§„åˆ™
  - match_application: WeChat
    replace:
      application: å¾®ä¿¡
      description: ä¸€ä¸ªå°è€Œç¾çš„åŠå…¬è½¯ä»¶
  - match_application: QQ
    replace:
      application: QQ
      description: ä¸€ä¸ªå¤šåŠŸèƒ½çš„é€šè®¯è½¯ä»¶
  - match_application: Netease Cloud Music
    replace:
      application: ç½‘æ˜“äº‘éŸ³ä¹
      description: ä¸€ä¸ªéŸ³ä¹æ’­æ”¾å’Œåˆ†äº«çš„å¹³å°          
```

ç¼–è¾‘å¥½å `CTRL + S` ä¿å­˜å¹¶å…³é—­ï¼Œç„¶åå†è¿è¡Œ Kizunaï¼Œå°±ä¼šå®šæ—¶å¾€å®šä¹‰çš„ç«¯ç‚¹ä¸Šä¼ ä½ çš„æ´»åŠ¨æ•°æ®

## å‚è€ƒé“¾æ¥

[Mix Space å®˜æ–¹æ–‡æ¡£](https://mx-space.js.org/docs/core)

[Mix-Spaceéƒ¨ç½²æœ€æ–°å‰ç«¯Shiro](https://www.vlo.cc/posts/jc/shiro)

[Mix-Space æ­å»ºä»å…¥é—¨åˆ°å…¥åœŸ](https://blxcwg666.xlog.app/68.html)